<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Servidores</title>
    <link rel="icon" href="./assets/logos/logo_vetorizada.svg" type="image/x-icon">
    <link rel="stylesheet" href="style/sidebar.css">
    <link rel="stylesheet" href="style/essencial.css">
    <link rel="stylesheet" href="style/tela_usuarios.css">
    <link rel="stylesheet" href="style/filtros.css">
    <link rel="stylesheet" href="style/popup.css">
</head>

<body onload="listarUsuarios()">
    <nav id="id_sidebar"></nav>
    <div id="id_info_kpis"></div>
    <div id="popup_screen"></div>


    <div class="page_content">
        <!-- Info-card -->
        <div class="headers">
            <div class="card_adicionar" onclick="popup_cadastrar_usuario()">
                <img src="./assets/icons/icone_usuarioAdicionar.svg" alt="">
                <h2>Adicionar Usuário</h2>
            </div>
            <div class="info-card">
                <h2>Total Usuários:</h2>
                <h1 id="totalUsuarios">0</h1>
            </div>
        </div>

        <!-- Filtros de persquisa -->
        <div class="filtros">
            <select id="id_filter" onchange="">
                <option value="" selected>Todos os cargos</option>
            </select>
            <input type="search" placeholder="Digite para pesquisar">
        </div>

        <!-- Lista de Usuários -->

        <div class="container_usuarios">
            <div class="usuarios_infos">
                <div class="usuario_info_foto">Foto</div>
                <div class="usuario_info_nome">Nome</div>
                <div class="usuario_info_cargo">Cargo</div>
                <div class="usuario_info_email">Email</div>
                <div class="usuario_info_telefone">Telefone</div>
                <div class="usuario_info_dataCadastro">Data de Cadastro</div>
            </div>
            <div id="lista_usuarios" class="lista_usuarios">
                <div class="card_usuario" id="1" onclick="popup_usuario(this, this.id)">
                    <div id="usuario_foto">
                        <img src="./assets/fotosPerfil/fotoPerfil.png" alt="">
                    </div>
                    <p id="usuario_nome">Baltazar Bernado</p>
                    <p id="usuario_cargo">Usuário</p>
                    <p id="usuario_email">baltazarbernado@gmail.com</p>
                    <p id="usuario_telefone">1191710375</p>
                    <p id="usuario_dataCadastro">24/07/2025</p>
                </div>

            </div>
        </div>
    </div>
</body>

</html>
<script src="js/sidebar.js"></script>
<script src="js/popups.js"></script>
<script>
    function funcao_adicionar() {
        mensagem_erro.innerHTML = '';
        let userNome = ipt_nome.value;
        let userSobrenome = ipt_sobrenome.value;
        let userCargo = ipt_cargo.value;
        let userEmail = ipt_email.value;
        let userSenha = ipt_senha.value;
        let userConfirmarSenha = ipt_confirmar_senha.value;
        let userTelefone = ipt_telefone.value;

        if (!userNome || !userSobrenome || !userCargo || !userEmail || !userSenha || !userConfirmarSenha || !userTelefone) {
            mensagem_erro.innerHTML = `Todos os campos precisam ser preenchidos!`;
            return;
        }

        let validacaoEmail = userEmail.indexOf('@') != -1;
        if (!validacaoEmail) {
            mensagem_erro.innerHTML = `Email inválido!`;
            return;
        }

        let regexTelefoneBR = /^\(?([1-9]{2})\)?\s?9?\d{4}[-\s]?\d{4}$/;
        if (!regexTelefoneBR.test(userTelefone)) {
            mensagem_erro.innerHTML = `Número de telefone inválido!`;
        } else {
            var userTelefoneLimpo = userTelefone.replace(/[\s()\-]/g, '');
        }

        let validacaoSenha = 0;

        if (userSenha.length < 8) {
            mensagem_erro.innerHTML = `A senha deve conter ao menos 8 caracteres<br>`;
            validacaoSenha = 1;
        }

        if (!/[a-z]+/.test(userSenha)) {
            mensagem_erro.innerHTML = `A senha deve conter ao menos uma letra minúscula<br>`;
            validacaoSenha = 1;
        }

        if (!/[A-Z]+/.test(userSenha)) {
            mensagem_erro.innerHTML = `A senha deve conter ao menos uma letra maiúscula<br>`;
            validacaoSenha = 1;
        }

        if (!/[@!#$%*]+/.test(userSenha)) {
            mensagem_erro.innerHTML = `A senha deve conter ao menos um caractere especial<br>`;
            validacaoSenha = 1;
        }

        if (validacaoSenha == 1) {
            return;
        }

        if (userSenha != userConfirmarSenha) {
            mensagem_erro.innerHTML = `Os campos 'Senha' e 'Confirmar Senha' devem ser iguais.`
        }

        fetch(`/usuarios/cadastrar`, {
            method: 'POST',
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                nomeUsuarioServer: userNome,
                sobrenomeUsuarioServer: userSobrenome,
                emailUsuarioServer: userEmail,
                senhaUsuarioServer: userSenha,
                fkEmpresaServer: sessionStorage.ID_EMPRESA,
                fkCargoServer: userCargo,
                telefoneUsuarioServer: userTelefoneLimpo
                //isAdminServer: 1 --> Importante rever.
            })
        }).then(function (resposta) {
            console.log("resposta: ", resposta);

            if (resposta.ok) {
                mensagem_erro.innerHTML = `Usuário cadastrado com sucesso!`;

                setTimeout(function () {
                    location.reload(true);
                }, 2000);
            }
        }).catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
        });
    }

    function listarUsuarios() {
        let idEmpresa = sessionStorage.ID_EMPRESA;

        fetch(`/usuarios/buscarUsuarios/${idEmpresa}`, {
            method: 'GET',
            headers: {
                "Content-Type": "application/json"
            }
        }).then(function (response) {
            if (!response.ok) {
                throw new Error(`Erro HTTP: ${response.status}`);
            }
            return response.json();
        }).then(function (dadosUsuarios) {
            console.log(dadosUsuarios);
            for (let i = 0; i < dadosUsuarios.length; i++) {
                let data = dadosUsuarios[i].data_cadastro.split('T');
                let partes = data[0].split('-');
                let dataFormatada = `${partes[2]}/${partes[1]}/${partes[0]}`;
                lista_usuarios.innerHTML += `
                <div class="card_usuario" id="${dadosUsuarios[i].idUsuario}" onclick="popup_usuario(this, this.id)">
                    <div id="usuario_foto">
                        <img src="./assets/fotosPerfil/fotoPerfil.png" alt="">
                    </div>
                    <p id="usuario_nome">${dadosUsuarios[i].nome} ${dadosUsuarios[i].sobrenome}</p>
                    <p id="usuario_cargo">${dadosUsuarios[i].nome_cargo}</p>
                    <p id="usuario_email">${dadosUsuarios[i].email}</p>
                    <p id="usuario_telefone">${dadosUsuarios[i].telefone}</p>
                    <p id="usuario_dataCadastro">${dataFormatada}</p>
                </div>`
            }
            totalUsuarios.innerHTML = dadosUsuarios.length;
        }).catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
        });
    }
</script>