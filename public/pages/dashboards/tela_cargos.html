<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cargos</title>
    <link rel="icon" href="../../assets/logos/logo_vetorizada.svg" type="image/x-icon">
    <link rel="stylesheet" href="../../style/sidebar.css">
    <link rel="stylesheet" href="../../style/essencial.css">
    <link rel="stylesheet" href="../../style/tela_cargos.css">
    <link rel="stylesheet" href="../../style/filtros.css">
    <link rel="stylesheet" href="../../style/popup.css">
</head>

<body onload="listarCargos()">
    <nav id="id_sidebar"></nav>
    <div id="id_info_kpis"></div>
    <div id="popup_screen"></div>


    <div class="page_content">
        <!-- Info-card -->
        <div class="cargos_container">
            <div class="card">
                <div class="header">
                    <h1>Cargos</h1>
                    <div>
                        <img class="icon_cargo" src="../../assets/icons/icone_adicionar_cargo.svg" alt=""
                            onclick="popup_adicionar_cargos()">
                        <img class="icon_cargo" src="../../assets/icons/icone_deletar.svg" alt=""
                            onclick="popup_deletar_cargos(listaIdDelete)">
                    </div>
                </div>
                <div class="cargos_lista" id="listaCargos">
                    <!-- <div class="card_cargo">
                        <div id="cargo_checkbox">
                            <input type="checkbox" class="checkbox">
                        </div>
                        <h2>Admnistrador</h2>
                    </div>
                    <div class="card_cargo">
                        <div id="cargo_checkbox">
                            <input type="checkbox" class="checkbox">
                        </div>
                        <h2>Analista</h2>
                    </div> -->
                </div>
            </div>

            <!-- Permissões -->
            <div class="card">
                <div class="header">
                    <h1>Permissões</h1>
                    <div class="opcoes">
                        <select id="selectCargoAtualizar" onchange="listarPermissoes(this.value)">
                        <option value="0" disabled selected>Escolha um cargo para atualizar...</option>
                    </select>
                    <button onclick="popup_alterar_permissoes(selectCargoAtualizar.value, listaPermissoesAdicionar, listaPermissoesRetirar)">Confirmar alterações</button>
                    </div>
                
                </div>

                <div class="permissoes_lista">
                    <h2>Usuários</h2>
                    <div id="permissoesUsuario">
                        <div class="card_permissao">
                            <div id="adicionar_usuario">
                                <input type="checkbox" class="checkbox" value="1" id="checkbox1"
                                    onchange="adicionarListaPermissoes(this)">
                            </div>
                            <h2>Adicionar Usuário</h2>
                        </div>
                        <div class="card_permissao">
                            <div id="editar_usuario">
                                <input type="checkbox" class="checkbox" value="2" id="checkbox2"
                                    onchange="adicionarListaPermissoes(this)">
                            </div>
                            <h2>Editar Usuário</h2>
                        </div>
                        <div class="card_permissao">
                            <div id="excluir_usuario">
                                <input type="checkbox" class="checkbox" value="3" id="checkbox3"
                                    onchange="adicionarListaPermissoes(this)">
                            </div>
                            <h2>Excluir Usuário</h2>
                        </div>
                        <div class="card_permissao">
                            <div id="excluir_usuario">
                                <input type="checkbox" class="checkbox" value="4" id="checkbox4"
                                    onchange="adicionarListaPermissoes(this)">
                            </div>
                            <h2>Editar Perfil</h2>
                        </div>
                    </div>

                    <h2>Servidor</h2>
                    <div id="permissoesServidor">
                        <div class="card_permissao">
                            <div id="adicionar_servidor">
                                <input type="checkbox" class="checkbox" value="5" id="checkbox5"
                                    onchange="adicionarListaPermissoes(this)">
                            </div>
                            <h2>Adicionar Servidor</h2>
                        </div>
                        <div class="card_permissao">
                            <div id="editar_servidor">
                                <input type="checkbox" class="checkbox" value="6" id="checkbox6"
                                    onchange="adicionarListaPermissoes(this)">
                            </div>
                            <h2>Editar Servidor</h2>
                        </div>
                        <div class="card_permissao">
                            <div id="excluir_servidor">
                                <input type="checkbox" class="checkbox" value="7" id="checkbox7"
                                    onchange="adicionarListaPermissoes(this)">
                            </div>
                            <h2>Excluir Servidor</h2>
                        </div>
                    </div>

                    <h2>Data Centers</h2>
                    <div id="permissoesDataCenter">
                        <div class="card_permissao">
                            <div id="adicionar_datacenter">
                                <input type="checkbox" class="checkbox" value="8" id="checkbox8"
                                    onchange="adicionarListaPermissoes(this)">
                            </div>
                            <h2>Adicionar Data Center</h2>
                        </div>
                        <div class="card_permissao">
                            <div id="editar_datacenter">
                                <input type="checkbox" class="checkbox" value="9" id="checkbox9"
                                    onchange="adicionarListaPermissoes(this)">
                            </div>
                            <h2>Editar Data Center</h2>
                        </div>
                        <div class="card_permissao">
                            <div id="excluir_datacenter">
                                <input type="checkbox" class="checkbox" value="10" id="checkbox10"
                                    onchange="adicionarListaPermissoes(this)">
                            </div>
                            <h2>Excluir Data Center</h2>
                        </div>
                    </div>

                    <h2>Cargos</h2>
                    <div id="permissoesCargo">
                        <div class="card_permissao">
                            <div id="adicionar_cargo">
                                <input type="checkbox" class="checkbox" value="11" id="checkbox11"
                                    onchange="adicionarListaPermissoes(this)">
                            </div>
                            <h2>Adicionar Cargo</h2>
                        </div>
                        <div class="card_permissao">
                            <div id="editar_cargo">
                                <input type="checkbox" class="checkbox" value="12" id="checkbox12"
                                    onchange="adicionarListaPermissoes(this)">
                            </div>
                            <h2>Editar Cargo</h2>
                        </div>
                        <div class="card_permissao">
                            <div id="excluir_cargo">
                                <input type="checkbox" class="checkbox" value="13" id="checkbox13"
                                    onchange="adicionarListaPermissoes(this)">
                            </div>
                            <h2>Excluir Cargo</h2>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</body>

</html>
<script src="../../js/sidebar.js"></script>
<script src="../../js/popups.js"></script>
<script src="../../js/verificacaoPermissoes.js"></script>
<script>
    verificarPermissoesSideBar();

    // Selecionar um cargo
    const cargos = document.querySelectorAll('.card_cargo');

    cargos.forEach(cargo => {
        cargo.addEventListener('click', () => {
            cargos.forEach(c => c.classList.remove('selecionado'));
            cargo.classList.add('selecionado');
        });
    });

    let listaIdDelete = [];

    function adicionarListaDelete(checkbox) {
        if (checkbox.checked) {
            listaIdDelete.push(checkbox.value);
        } else {
            let indexARetirar = listaIdDelete.indexOf(checkbox.value);
            listaIdDelete.splice(indexARetirar, 1);
        }
        console.log(listaIdDelete);
    }

    let listaPermissoesAdicionar = [];
    let listaPermissoesRetirar = [];

    function adicionarListaPermissoes(checkbox) {
        let permissaoId = Number(checkbox.value);
        console.log(listaIdPermissoes.indexOf(permissaoId));
        if (checkbox.checked) {
            if (listaIdPermissoes.indexOf(permissaoId) == -1) {
                listaPermissoesAdicionar.push(permissaoId);
            }

            if (listaIdPermissoes.indexOf(permissaoId) != -1 && listaPermissoesRetirar.indexOf(permissaoId) != -1) {
                let indexARetirar = listaPermissoesRetirar.indexOf(permissaoId);
                listaPermissoesRetirar.splice(indexARetirar, 1);
            }
        }

        if (!checkbox.checked) {
            if (listaIdPermissoes.indexOf(permissaoId) != -1) {
                listaPermissoesRetirar.push(permissaoId);
            }

            if (listaIdPermissoes.indexOf(permissaoId) == -1 && listaPermissoesAdicionar.indexOf(permissaoId) != -1) {
                let indexARetirar = listaPermissoesAdicionar.indexOf(permissaoId);
                listaPermissoesAdicionar.splice(indexARetirar, 1);
            }
        }

        console.log(listaPermissoesAdicionar);
        console.log(listaPermissoesRetirar);
    }

    function listarCargos() {
        let empresaId = sessionStorage.empresaId;

        fetch(`/usuarios/listarCargos/${empresaId}`, {
            method: 'GET',
            headers: {
                "Content-Type": "application/json"
            }
        }).then(function (response) {
            if (!response.ok) {
                throw new Error(`Erro HTTP: ${response.status}`);
            }
            return response.json();
        }).then(function (dadosCargos) {
            for (let i = 0; i < dadosCargos.length; i++) {
                selectCargoAtualizar.innerHTML += `<option value="${dadosCargos[i].idCargo}">${dadosCargos[i].nome_cargo}</option>`;
                listaCargos.innerHTML += `
                    <div class="card_cargo">
                        <div id="cargo_checkbox">
                            <input type="checkbox" class="checkbox" value="${dadosCargos[i].idCargo}" onchange="adicionarListaDelete(this)">
                        </div>
                        <h2>${dadosCargos[i].nome_cargo}</h2>
                    </div>
                `
            }
        })
    }

    function deletar_cargo() {
        for (let i = 0; i < listaIdDelete.length; i++) {
            fetch(`/cargos/deletarCargo/${listaIdDelete[i]}`, {
                method: 'DELETE',
            }).then(function (response) {
                if (response.ok) {
                    console.log(`Usuário ID ${listaIdDelete[i]} deletado com sucesso!`);

                    location.reload();
                } else {
                    console.error(`Falha ao deletar o usuário ${listaIdDelete[i]}. Status: ${response.status}`);
                }
            })
                .catch(function (error) {
                    console.error("Erro de rede:", error);
                });
        }
    }

    let listaIdPermissoes = [];

    function listarPermissoes(idCargo) {
        listaPermissoesAdicionar = [];
        listaPermissoesRetirar = [];
        fetch(`/cargos/listarPermissoes/${idCargo}`, {
            method: 'GET',
            headers: {
                "Content-Type": "application/json"
            }
        }).then(function (response) {
            if (!response.ok) {
                throw new Error(`Erro HTTP: ${response.status}`);
            }
            return response.json();
        }).then(function (dadosPermissoes) {
            listaPermissoes = [];
            for (var i = 0; i < dadosPermissoes.length; i++) {
                listaPermissoes.push(dadosPermissoes[i].permissoes_idPermissao)
            }
            listaIdPermissoes = listaPermissoes;
            console.log(listaIdPermissoes)

            for (let i = 1; i <= 13; i++) {
                let checkbox = document.getElementById(`checkbox${i}`);
                checkbox.checked = false;
                if (listaIdPermissoes.indexOf(i) != -1) {
                    checkbox.checked = true;
                }
            }
        })
    }

    function alterar_permissoes(idCargo) {
        console.log(listaPermissoesAdicionar)
        if (listaPermissoesAdicionar.length != 0) {
            for (let i = 0; i < listaPermissoesAdicionar.length; i++) {
                fetch(`/cargos/adicionarPermissao`, {
                    method: 'POST',
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        cargoId: idCargo,
                        permissaoId: listaPermissoesAdicionar[i]
                    })
                }).then(function (resposta) {
                    console.log("resposta: ", resposta);

                    if (resposta.ok) {
                        mensagem_erro.innerHTML = `Permissões alteradas com sucesso!`;
                    } else {
                        console.error(`Falha ao alterar permissões. Status: ${resposta.status}`);
                    }
                }).catch(function (resposta) {
                    console.log(`#ERRO: ${resposta}`);
                });
            }
        }

        if (listaPermissoesRetirar.length != 0) {
            for (let i = 0; i < listaPermissoesRetirar.length; i++) {
                fetch(`/cargos/removerPermissao/${idCargo}/${listaPermissoesRetirar[i]}`, {
                    method: 'DELETE',
                }).then(function (response) {
                    console.log("resposta: ", response);
                    
                    if (response.ok) {
                        mensagem_erro.innerHTML = `Permissões alteradas com sucesso!`;
                    } else {
                        console.error(`Falha ao retirar permissões. Status: ${response.status}`);
                    }
                })
                    .catch(function (error) {
                        console.error("Erro:", error);
                    });
            }
        }

        setTimeout(function () {
            location.reload(true);
        }, 2000);
    }
</script>