<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <title>Ally</title>
  <link rel="icon" href="../../assets/logos/logo_vetorizada.svg" type="image/x-icon">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="../../style/sidebar.css">
  <link rel="stylesheet" href="../../style/popup.css">
  <link rel="stylesheet" href="../../style/Ally2.css">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


</head>

<body>
  <nav id="id_sidebar"></nav>
  <div id="id_info_kpis"></div>
  <div id="popup_screen"></div>
  <h1 class="titulo" id="titulo">Datacenter Orlando</h1>
  <div class="container">

    <div class="cards">
      <section class="cards_kpi" id="cards_kpi">
        <div class="card">
          <p>CPU (Ãºlt.)</p>
          <h2 id="cpu">47%</h2>
        </div>
        <div class="card">
          <p>RAM (Ãºlt.)</p>
          <h2 id="ram">61%</h2>
        </div>
        <div class="card">
          <p>Disco (Ãºlt.)</p>
          <h2 id="disco">78%</h2>
        </div>
        <div class="card">
          <p>LatÃªncia</p>
          <h2 id="latencia">0.032s</h2>
        </div>
        <div class="card">
          <p>Rede</p>
          <h2 id="rede">2.8 MB</h2>
        </div>
        <div class="card">
          <p>Processos</p>
          <h2 id="processos">135</h2>
        </div>
      </section>
    </div>

    <div class="rankingServidores">
      <h2 class="subtitulo">Servidores</h2>
      <div id="rankServer" class="rankServer">
      </div>
    </div>

    <div id="grafico_radar" class="grafico_radar">
      <div class="kpi">
        <h3>GrÃ¡fico comparativo</h3>
        <select id="selectServer" onchange="mudarServidor()">
        </select>
        <div class="kpis">
          <p>Saude: <span id="Saude"></span>%</p>
          <p>Rede: <span id="Rede"></span>%</p>
          <p>Disco: <span id="Disco"></span>%</p>
          <p>CPU: <span id="Cpu"></span>%</p>
          <p>RAM: <span id="Ram"></span>%</p>
        </div>
      </div>
      <canvas id="radarChart" class="grafico"></canvas>
    </div>
  </div>
  </div>
  <button onclick="popUp_IA()" class="logo_Ia" id="logoIa"><img src="../../assets/logos/logo_vetorizada.svg"
      alt=""></button>

  <div class="popup_IA desativada" id="popUpIA">
    <button onclick="popUp_fechar()" class="fechar_popUp"><img src="../../Images/voltar-branco.svg" alt=""></button>
    <h2>Dicas IA Monitora</h2>
    <div class="MensagemIA" id="MensagemIA">
    </div>
  </div>

  <footer>
    <div class="dashButtons">
      <a href="./home.html"><img style="border-radius: 0 !important" src="../../Images/home.svg" alt=""></a>
      <a href="./Ally.html"><img src="../../Images/Colaboradores/Colaborador1.svg" alt=""></a>
      <a href="./Gustavo.html"><img src="../../Images/Colaboradores/Colaborador2.svg" alt=""></a>
      <a href="./Leonardo.html"><img src="../../Images/Colaboradores/Colaborador3.svg" alt=""></a>
      <a href="./Maria.html"><img src="../../Images/Colaboradores/Colaborador4.svg" alt=""></a>
      <a href="./Pedro.html"><img src="../../Images/Colaboradores/Colaborador5.svg" alt=""></a>
    </div>
    <p>Developed by <a href="https://www.linkedin.com/in/ally-awada">AllyAwada</a></p>
  </footer>
</body>

</html>

<script src="../../js/sidebar.js"></script>
<script src="../../js/popups.js"></script>
<script src="../../js/verificacaoPermissoes.js"></script>
<script>
  if (sessionStorage.empresaCnpj == undefined) {
    listarPermissoesReload();
    verificarPermissoesSideBar();
    setInterval(executarVerificacaoPermissoes, 30000);
  }

  function executarVerificacaoPermissoes() {
    if (sessionStorage.empresaCnpj == undefined) {
      listarPermissoesReload();
      verificarPermissoesSideBar();
    }
  }

  if (sessionStorage.empresaCnpj == undefined) {
    verificarPermissoesSideBar();
  }


  var radarChartInstance;
  const dadosDc = JSON.parse(sessionStorage.datacenter);
  const Servidores = [];
  const ServidoresAnteriores = [];
  async function dadosServidores() {
    var caminho = `${sessionStorage.empresaId}%2FdataCenter%2F${dadosDc.IdDataCenter}%2Fsnapshots%2F`;

    return fetch(`/bucket/read/${caminho}/1`, {
      method: 'GET',
      headers: {
        "Content-Type": "application/json"
      }
    }).then(function (response) {
      if (!response.ok) {
        throw new Error("Erro ao buscar snapshot: " + response.status);
      }
      return response.json()
    }).then(function (data) {

      var dados = data.rows;
      var retorno = [];

      for (let i = 0; i < dados.length; i++) {
        dataAtual = dados[i];
        var temp = {
          idServidor: dataAtual.idServidor,
          timestamp: dataAtual.timestamp,
          Cpu: Number(dataAtual.cpu),
          Ram: Number(dataAtual.ram),
          Disco: Number(dataAtual.disco),
          Rede: Number(dataAtual.rede),
          latencia: Number(dataAtual.latencia),
          processos: Number(dataAtual.processos),
          Saude: Number(dataAtual.saude),
          up: dataAtual.up,
          cor: dataAtual.cor
        }
        ServidoresAnteriores.push(temp)
      }
      return fetch(`/bucket/read/${caminho}/0`, {
        method: 'GET',
        headers: {
          "Content-Type": "application/json"
        }
      }).then(function (response) {
        if (!response.ok) {
          throw new Error("Erro ao buscar snapshot: " + response.status);
        }
        return response.json()
      }).then(function (data) {

        var dados = data.rows;
        var retorno = [];
        var MediaLatencia = 0;
        var processosTotais = 0;
        for (let i = 0; i < dados.length; i++) {
          console.log("Estou no for " + dados.length)
          dataAtual = dados[i];
          var diferencaVar =  Number(dataAtual.saude) - ServidoresAnteriores[i].Saude;
          if (diferencaVar >= 0){
            var upVar = true;
          } else{
            var upVar = false;
          }

          MediaLatencia += Number(dataAtual.latencia);
          processosTotais += Number(dataAtual.processos);
          var temp = {
            idServidor: dataAtual.idServidor,
            timestamp: dataAtual.timestamp,
            Cpu: Number(dataAtual.cpu).toFixed(2),
            Ram: Number(dataAtual.ram).toFixed(2),
            Disco: Number(dataAtual.disco).toFixed(2),
            Rede: Number(dataAtual.rede).toFixed(2),
            latencia: Number(dataAtual.latencia).toFixed(2),
            processos: Number(dataAtual.processos).toFixed(2),
            Saude: Number(dataAtual.saude).toFixed(2),
            up: upVar,
            cor: dataAtual.cor,
            diferenca: diferencaVar.toFixed(2)
          }
          MediaLatencia = MediaLatencia / dados.length;
          dadosDc.Latencia = MediaLatencia.toFixed(2);
          dadosDc.Processos = processosTotais.toFixed(2);
          Servidores.push(temp)
        }

        for (let i = 0; i <= Servidores.length - 1; i++) {
          var idServer = Servidores[i].idServidor;
          return fetch(`/servidores/buscarNomeServidor/${idServer}`, {
            method: 'GET',
            headers: {
              "Content-Type": "application/json"
            }
          }).then(function (response) {
            if (!response.ok) {
              throw new Error(`Erro HTTP: ${response.status}`);
            }
            return response.json();
          }).then(function (nomeServer) {
            Servidores[i].nome = nomeServer[0].nome;
          }).catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
          });
        }
      }).catch(function (resposta) {
        console.log(`#ERRO: ${resposta}`);
      });
    }).catch(function (resposta) {
      console.log(`#ERRO: ${resposta}`);
    });
  }

  function inicial() {
    titulo.innerHTML = `${dadosDc.nome}`;
    cpu.innerHTML = `${dadosDc.Cpu}%`;
    ram.innerHTML = `${dadosDc.Ram}%`;
    disco.innerHTML = `${dadosDc.Disco}%`;
    latencia.innerHTML = `${dadosDc.Latencia}S`;
    rede.innerHTML = `${dadosDc.Rede}%`;
    processos.innerHTML = `${dadosDc.Processos}`;
  }

  function rankingServidores() {
    rankServer.innerHTML = "";


    for (let i = 0; i < Servidores.length; i++) {

      let estado = "";
      let iconStatus = "";

      if (Servidores[i].Saude >= 90) {
        estado = "ok";
        iconStatus = "ok.svg";
      } else if (Servidores[i].Saude >= 70) {
        estado = "alerta";
        iconStatus = "alerta.svg";
      } else {
        estado = "critico";
        iconStatus = "critico.svg";
      }
      let clsComparativo = Servidores[i].up ? "comparativo_up" : "comparativo_down";
      let iconComparativo = Servidores[i].up ? "lineUp.svg" : "lineDown.svg";

      rankServer.innerHTML += `
      <div class="popup-Server" onclick="dashServer(${i})">
        <div class="status status_${estado}">
          <img src="../../Images/PopUpsDash/${iconStatus}" alt="">
        </div>
        <div class="contentServer">
          <div class="first">
            <img class="icon" src="../../Images/PopUpsDash/iconServer.svg" alt="">
              <p>${Servidores[i].nome}</p>
          </div>
          <div class="seccond seccond_${estado}">
            <h3 class="kpi">${Servidores[i].Saude}%</h3>
            <section class="comparativo ${clsComparativo}">
              <p class="kpi">
                <img src="../../Images/PopUpsDash/${iconComparativo}" alt="">
                  ${Servidores[i].diferenca}%
              </p>
              <p>vs Ãºltima semana</p>
            </section>
          </div>
        </div>
      </div>`;
    }
  }
  function dashServer(index) {
    sessionStorage.servidor = JSON.stringify(Servidores[index]);
    window.location = "./Pedro.html";
  }

  function carregarSelectRadar() {
    const select = document.getElementById("selectServer");
    select.innerHTML = "";

    Servidores.forEach((server, index) => {
      select.innerHTML += `<option value="${index}">${server.nome}</option>`;
    });

    mudarServidor();
  }

  function criarRadarInicial() {
    const ctx = document.getElementById("radarChart");

    radarChartInstance = new Chart(ctx, {
      type: "radar",
      data: {
        labels: ["SaÃºde", "Disco", "RAM", "CPU", "Rede"],
        datasets: [
          {
            label: "Servidor selecionado",
            data: [0, 0, 0, 0, 0],
            backgroundColor: "rgba(0, 0, 0, 0.15)",
            borderColor: "#000000",
            fill: true,
            borderWidth: 2
          },
          {
            label: "Limites",
            data: [82, 70, 68, 80, 88],
            backgroundColor: "rgba(31, 84, 126, 0.15)",
            borderColor: "#1F547E",
            fill: true,
            borderWidth: 2
          }
        ]
      },
      options: {
        responsive: false,
        plugins: {
          legend: {
            labels: {
              color: "#1F547E"
            }
          }
        },
        scales: {
          r: {
            grid: {
              color: "#E5E4E2"
            },
            pointLabels: {
              color: "#1F547E"
            },
            suggestedMin: 0,
            suggestedMax: 100
          }
        }
      }
    });
  }

  function mudarServidor() {
    const index = document.getElementById("selectServer").value;
    const server = Servidores[index];
    const serverAnterior = ServidoresAnteriores[index];
    document.getElementById("Saude").innerText = server.Saude;
    document.getElementById("Rede").innerText = server.Rede;
    document.getElementById("Disco").innerText = server.Disco;
    document.getElementById("Cpu").innerText = server.Cpu;
    document.getElementById("Ram").innerText = server.Ram;

    atualizarRadar(server, serverAnterior);
  }

  function atualizarRadar(server, serverAnterior) {
    radarChartInstance.data.datasets[0].label = server.nome;
    radarChartInstance.data.datasets[0].data = [
      server.Saude,
      server.Disco,
      server.Ram,
      server.Cpu,
      server.Rede
    ];

    radarChartInstance.data.datasets[1].data = [
      serverAnterior.Saude,
      serverAnterior.Disco,
      serverAnterior.Ram,
      serverAnterior.Cpu,
      serverAnterior.Rede
    ];

    radarChartInstance.data.datasets[0].backgroundColor = server.cor + "33";
    radarChartInstance.data.datasets[0].borderColor = server.cor;

    radarChartInstance.update();
  }

  var mensagemdaia = `<p>ðŸ”„ RedistribuiÃ§Ã£o recomendada: mover 20% da carga do DC Paulista para o DC Orlando <br>âš  Anomalia detectada: aumento de 12% de latÃªncia no DC RÃºssia nas Ãºltimas 3h <br>ðŸŸ© Orlando estÃ¡ apto para receber novas instÃ¢ncias <br>ðŸª« Paulista perto do limite de disco (82%)</p>`;
  function popUp_IA() {
    MensagemIA.innerHTML = `${mensagemdaia}`;
    popUpIA.classList.remove("desativada");
    popUpIA.classList.add("ativada");
    setTimeout(() => { logoIa.onclick = popUp_fechar }, 800)
  }

  function popUp_fechar() {
    MensagemIA.innerHTML = "";
    popUpIA.classList.remove("ativada");
    popUpIA.classList.add("desativada");
    setTimeout(() => { logoIa.onclick = popUp_IA }, 800)
  }

  window.onload = () => {
    listarPermissoesReload();
    dadosServidores().then(() =>{
      inicial();
      rankingServidores();
      criarRadarInicial();
      carregarSelectRadar();
    });
  };
</script>