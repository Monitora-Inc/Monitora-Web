<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1.0" name="viewport" />
  <title>Monitor de Eficiência de RAM</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>

  <link rel="icon" href="../../assets/logos/logo_vetorizada.svg" type="image/x-icon">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="../../style/sidebar.css">
  <link rel="stylesheet" href="../../style/essencial.css">
  <link rel="stylesheet" href="../../style/tela_home.css">
  <link rel="stylesheet" href="../../style/filtros.css">
  <link rel="stylesheet" href="../../style/popup.css">
  <link rel="stylesheet" href="../../style/Gusz.css">
</head>

<body class="bg-background font-body text-text-secondary"onload="listarPermissoesReload(), preencherKpisServidoresAlertas()">
  <nav id="id_sidebar"></nav>
  <div id="id_info_kpis"></div>
  <div id="popup_screen"></div>
  <div class="page-content" id="grandona">
    <div class="titulos">
      <header class="">
        <div class="">
          <h1 class="text-3xl font-bold leading-tight tracking-tighter text-text-primary font-display">Monitor de
            Eficiência de RAM</h1>
          <h2 id="nomeServidorHTML"></h2>
          <h3 class="text-text-secondary">Insights sobre a RAM de seus servidores</h3>
        </div>
        <div class="flex flex-wrap items-center gap-4"></div>
      </header>
      <div class="configuracoes">
          <a class="tooltip icone_tooltip" onclick="pop_up_info('dashboard_help')">
            <img src="https://imgs.search.brave.com/KqVon09unuSLNfr0t50gUdi44r6hkfwQbBCl5IM_lkA/rs:fit:860:0:0:0/g:ce/aHR0cHM6Ly9zdGF0/aWMudmVjdGVlenku/Y29tL3N5c3RlbS9y/ZXNvdXJjZXMvdGh1/bWJuYWlscy8wMjgv/MTQ5LzEyNi9zbWFs/bC8zZC1xdWVzdGlv/bi1tYXJrLWljb24t/cG5nLnBuZw" style="width: 3rem; height: 3rem;"></img>
          </a>
        </div>
    </div>
    <div class="kpis">
      <div class="kpi-card">
        <div class="kpi-title">Total RAM servidor</div>
        <div class="kpi-value" id="kpi_total_ram">--</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-title">Porcentagem média de uso RAM</div>
        <div class="kpi-value" id="kpi_avg_percent">--</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-title">Uso médio de RAM</div>
        <div class="kpi-value" id="kpi_avg_usage">--</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-title">RAM média ativa</div>
        <div class="kpi-value" id="kpi_avg_active">--</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-title">RAM média inativa</div>
        <div class="kpi-value" id="kpi_avg_inactive">--</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-title">Status RAM</div>
        <div class="kpi-value kpi-status" id="kpi_status">--</div>
      </div>
    </div>
    <div class="grafico-principal">
      <div class="titulo_dash">
        <h1>DADOS ATIVOS x DADOS INATIVOS</h1>

      </div>
      <div id="dashboard_principal"></div>
    </div>
    <div class="graficos-container" style="margin-bottom: 5rem;">
      <div class="grafico-item">
        <div class="titulo_dash">
          <div><h1>Ativos x Inativos(GB)</h1></div>
        </div>
        <div id="linhas_IneAtivos"></div>
      </div>

      <div class="kpis-side">
        <div class="kpi-card small">
          <div class="kpi-title2">Pico de uso RAM</div>
          <div class="kpi-value" id="kpi_peak_usage">--</div>
        </div>
        <div class="kpi-card small">
          <div class="kpi-title2">Tempo de funcionamento</div>
          <div class="kpi-value" id="kpi_uptime">--</div>
        </div>
        <div class="kpi-card small">
          <div class="kpi-title2">Pico de RAM ativa</div>
          <div class="kpi-value" id="kpi_peak_active">--</div>
        </div>
        <div class="kpi-card small">
          <div class="kpi-title2">Pico de RAM inativa</div>
          <div class="kpi-value" id="kpi_peak_inactive">--</div>
        </div>
      </div>
    </div>
  </div>

  <footer>
    <div class="dashButtons" id="footerButonsUnico">
      <a href="./home.html"><img style="border-radius:0" src="../../Images/home.svg"></a>
      <a href="./Gustavo.html"><img src="../../Images/Colaboradores/Colaborador2.svg"></a>
      <a href="./Pedro.html"><img src="../../Images/Colaboradores/Colaborador5.svg"></a>
    </div>
    <p>Developed by Gustavo Menezes</p>
  </footer>

</body>

</html>
<script src="../../js/sidebar.js"></script>
<script src="../../js/popups.js"></script>
<script src="../../js/verificacaoPermissoes.js"></script>
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
  if (sessionStorage.empresaCnpj == undefined) {
    listarPermissoesReload();
    verificarPermissoesSideBar();
    setInterval(executarVerificacaoPermissoes, 30000);
  }

  function executarVerificacaoPermissoes() {
    if (sessionStorage.empresaCnpj == undefined) {
      listarPermissoesReload();
      verificarPermissoesSideBar();
    }
  }

  if (sessionStorage.empresaCnpj == undefined) {
    verificarPermissoesSideBar();
  }



  const idEmpresa = sessionStorage.empresaId;
  const servidorId = sessionStorage.servidorUuid;
  const minhapasta = "ram_eficiencia";
  const prefix = `${idEmpresa}%2F${minhapasta}%2F${servidorId}`;

  function plotarDados(resposta) {
    // Função para fazer inner html e plotar graficos

    //ID:"87cbdc6a-8bb1-4be8-b881-dd7d847bb256"RAM-ATIVA: "4.46"RAM-INATIVA: "1.39"RAM-PERCENTUAL: "73.86"RAM-USADA: "5.48"STATUS-RAM: "NORMAL"
    // TIMESTAMP: "2025-12-03 18:48:19"TOTAL-RAM: "7.42"UPTIME: "15930"
    //--------Medias------


    //totais
    picoRAMAtiva = 0;
    picoRAMInativa = 0;
    picoRAM = 0;
    totalAtiva = 0;
    totalInativa = 0;
    totalPercent = 0;
    totalUsoRAM = 0;
    timestamps = []
    ramAtivaPercent = []
    ramInativaPercent = []
    ramAtiva = []
    ramInativa = []
    usoRAM = []
    for (i = 0; i < resposta.length; i++) {
      dado = resposta[i]
      if(resposta[i]["RAM-USADA"] > resposta[0]["RAM-USADA"]){
        picoRAM = i
      }
      if(resposta[i]["RAM-INATIVA"] > resposta[0]["RAM-INATIVA"]){
        picoRAMInativa = i
      }
      if(resposta[i]["RAM-ATIVA"] > resposta[0]["RAM-ATIVA"]){
        picoRAMAtiva = i
      }
      timestamps.push(dado.TIMESTAMP)
      ramAtiva.push(dado["RAM-ATIVA"])
      ramInativa.push(dado["RAM-INATIVA"])
      usoRAM.push(dado["RAM-USADA"])
      ramAtivaPercent.push((parseFloat(dado["RAM-ATIVA"]) / parseFloat(dado["RAM-USADA"])) * 100)
      ramInativaPercent.push((dado["RAM-INATIVA"] / dado["RAM-USADA"]) * 100)
      totalAtiva += parseFloat(dado["RAM-ATIVA"])
      totalInativa += parseFloat(dado["RAM-INATIVA"])
      totalUsoRAM += parseFloat(dado["RAM-USADA"])
      totalPercent += parseFloat(dado["RAM-PERCENTUAL"])
    }
    //KPIS---------------------------------------------
    mediaAtiva = totalAtiva / resposta.length
    mediaInativa = totalInativa / resposta.length
    mediaUsoRAM = totalUsoRAM / resposta.length
    mediaUsoRamPercent = totalPercent / resposta.length
    kpi_total_ram.innerHTML = dado["TOTAL-RAM"] + "GB"
    kpi_avg_percent.innerHTML = mediaUsoRamPercent.toFixed(2) + "%"
    kpi_avg_usage.innerHTML = mediaUsoRAM.toFixed(2) + "GB"
    kpi_avg_active.innerHTML = mediaAtiva.toFixed(2) + "GB"
    kpi_avg_inactive.innerHTML = mediaInativa.toFixed(2) + "GB"
    kpi_status.innerHTML = dado["STATUS-RAM"]

    //Segunda parte
    //Converter segundos em horas:
    
    horas = Math.floor(dado.UPTIME / 3600)
    restoHoras = dado.UPTIME % 3600
    minutos = Math.floor(restoHoras / 60)
    segundos = restoHoras % 60
    horas = String(horas).padStart(2, "0")
    minutos = String(minutos).padStart(2, "0")
    segundos = String(segundos).padStart(2, "0")

    time = horas + "h " + minutos + "m"
    kpi_uptime.innerHTML = time
    kpi_peak_usage.innerHTML = resposta[picoRAM]["RAM-USADA"] + "GB"
    kpi_peak_inactive.innerHTML = resposta[picoRAMInativa]["RAM-INATIVA"]+ "GB"
    kpi_peak_active.innerHTML = resposta[picoRAMAtiva]["RAM-ATIVA"]+ "GB"
    //---------------------------------------------KPIS
    console.log(
      "Media de dados ativos: " + mediaAtiva + "\n",
      "Media de dados inativos: " + mediaInativa + "\n",
      "Media uso RAM: " + mediaUsoRAM + "\n",
      "Porcentagem de uso: " + mediaUsoRamPercent
    )
    //Dashboards---------------------------------------


    //Utilizados vs Não Utilizados
    var options = {
      series: [{
        name: 'DADOS ATIVOS',
        data: ramAtivaPercent
      }, {
        name: 'DADOS INATVOS',
        data: ramInativaPercent
      }],
      chart: {
        type: 'bar',
        height: 350,
        stacked: true,
        stackType: '100%'
      },
      responsive: [{
        breakpoint: 480,
        options: {
          legend: {
            position: 'bottom',
            offsetX: -10,
            offsetY: 0
          }
        }
      }],
      xaxis: {
        categories: timestamps,
      },
      fill: {
        opacity: 1
      },
      legend: {
        position: 'right',
        offsetX: 0,
        offsetY: 50
      },
    };

    var chart = new ApexCharts(document.querySelector("#dashboard_principal"), options);
    chart.render();
    //----------------------------------------------------
    //Linha: Ativos e Inativos
    var options = {
      series: [{
        name: "Ativos",
        data: ramAtiva
      }, {
        name: "Inativos",
        data: ramInativa
      }, {
        name: "Uso RAM",
        data: usoRAM
      }

      ],
      chart: {
        height: 350,
        type: 'line',
        zoom: {
          enabled: false
        }
      },
      dataLabels: {
        enabled: false
      },
      stroke: {
        curve: 'straight'
      },
      title: {
        text: '',
        align: 'left'
      },
      grid: {
        row: {
          colors: ['#f3f3f3', 'transparent'], // takes an array which will be repeated on columns
          opacity: 0.5
        },
      },
      xaxis: {
        categories: timestamps,
      }
    };

    var chart = new ApexCharts(document.querySelector("#linhas_IneAtivos"), options);
    chart.render();
  }

  async function pegarDados(prefix, index) {
    try {
      const url = `/bucket/read/${prefix}/${index}`;
      const res = await fetch(url);
      if (!res.ok) {
        console.error("Erro HTTP:", res.status);
        const txt = await res.text();
        console.error("Resposta:", txt);
        return null;
      }

      const dados = await res.json();
      console.log("RESPOSTA:", dados.rows);

      return dados.rows;

    } catch (err) {
      console.error("Erro na função pegarDados():", err);
      return null;
    }
  }
  window.onload = () => {
    pegarDados(prefix, 0).then((dados) => {
      plotarDados(dados);
    });
    nomeServidorHTML.innerHTML = sessionStorage.servidorNome
  }
  //id empresa minha pasta id server


</script>
<script>
  server_nome.innerHTML= `${sessionStorage.servidorNome}`;
  server_localizacao.innerHTML= `${sessionStorage.servidorLocalizacao}`;

  function pop_up_info(texto) {
    // se for a chave 'dashboard_help', renderiza conteúdo organizado
    if (texto === 'dashboard_help') {
      const content = `
      <div style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;padding:1rem;z-index:2000;background:rgba(0,0,0,0.45);">
        <div style="width:100%;max-width:760px;background:#ffffff;border-radius:12px;box-shadow:0 10px 28px rgba(15,23,42,0.2);overflow:hidden;">
          <div style="background:#072F4E;color:#fff;padding:14px 18px;border-bottom:1px solid rgba(255,255,255,0.06);">
            <h1 style="margin:0;font-size:1.1rem;">Informações do Dashboard</h1>
          </div>

          <div style="max-height:60vh;overflow:auto;padding:16px 18px;font-size:0.95rem;color:#102231;line-height:1.5;">
            <h2 style="margin:0 0 8px 0;font-size:1rem;color:#072F4E;">Visão Geral</h2>
            <p style="margin:0 0 12px 0;text-align:justify;">Este dashboard apresenta métricas de uso de memória RAM do servidor e gráficos com tendências ao longo do tempo. Use as KPIs para obter um resumo rápido; consulte os gráficos para entender comportamento e variações.</p>

            <h3 style="margin-top:8px;margin-bottom:6px;color:#0e203a;">KPIs (principais)</h3>
            <ul style="margin:0 0 12px 18px;">
              <li><strong>Total RAM servidor:</strong> Capacidade total de memória do servidor (GB).</li>
              <li><strong>Porcentagem média de uso RAM:</strong> Média percentual de uso durante o período (%).</li>
              <li><strong>Uso médio de RAM:</strong> Média de memória usada em GB no período.</li>
              <li><strong>RAM média ativa / inativa:</strong> Médias da memória ativa (em uso) e inativa (em cache).</li>
              <li><strong>Status RAM:</strong> Indicador do estado (NORMAL / ALERTA / CRÍTICO).</li>
            </ul>

            <h3 style="margin-top:6px;margin-bottom:6px;color:#0e203a;">KPIs (laterais)</h3>
            <ul style="margin:0 0 12px 18px;">
              <li><strong>Pico de uso RAM:</strong> Maior valor observado de RAM usada (GB).</li>
              <li><strong>Pico de RAM ativa / inativa:</strong> Valores máximos registrados (GB).</li>
              <li><strong>Tempo de funcionamento:</strong> Uptime do servidor (segundos ou formato amigável).</li>
            </ul>

            <h3 style="margin-top:6px;margin-bottom:6px;color:#0e203a;">Gráficos</h3>
            <ul style="margin:0 0 12px 18px;">
              <li><strong>Gráfico principal:</strong> Barras empilhadas em percentual mostrando composição ativa vs inativa por timestamp.</li>
              <li><strong>Gráfico de linhas:</strong> Séries que mostram Ativos, Inativos e Uso RAM ao longo do tempo.</li>
            </ul>

            <h3 style="margin-top:6px;margin-bottom:6px;color:#0e203a;">Como interpretar</h3>
            <ol style="margin:0 0 12px 18px;">
              <li>Porcentagem média de uso alta (&gt;80%): investigar memória e processos.</li>
              <li>Picos: verificar horários e logs para eventos.</li>
              <li>RAM inativa alta pode ser cache; RAM ativa alta com pouca inativa indica pressão.</li>
            </ol>

            <h3 style="margin-top:6px;margin-bottom:6px;color:#0e203a;">Dicas rápidas</h3>
            <ul style="margin:0 0 8px 18px;">
              <li>Compare Total RAM com Uso médio para estimar margem livre.</li>
              <li>Use filtros de período para analisar janelas específicas.</li>
            </ul>
          </div>

          <div style="padding:12px 18px;background:#f6f9fc;border-top:1px solid #eef3fb;text-align:right;">
            <button onclick="fechar_popup()" style="background:#072F4E;color:#fff;border:none;padding:8px 14px;border-radius:6px;cursor:pointer;">Fechar</button>
          </div>
        </div>
      </div>`;

      document.getElementById("popup_screen").innerHTML = content;
      return;
    }

    // comportamento antigo: renderiza texto simples quando não é chave especial
    const f = texto.replace(/\n/g, "<br>");

    document.getElementById("popup_screen").innerHTML = `
      <div style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;padding:1rem;z-index:2000;background:rgba(0,0,0,0.45);">
        <div style="width:100%;max-width:680px;background:#ffffff;border-radius:10px;box-shadow:0 8px 24px rgba(15,23,42,0.18);overflow:hidden;">
          <div style="background:#072F4E;color:#fff;padding:12px 16px;">
            <h1 style="margin:0;font-size:1.05rem;">Informações</h1>
          </div>
          <div style="padding:14px 16px;max-height:56vh;overflow:auto;font-size:0.95rem;line-height:1.45;color:#102231;">
            <div style="text-align:center;font-weight:700;margin-bottom:8px;">${f.split("<br>")[0]}</div>
            <div style="text-align:justify;">${f.substring(f.indexOf("<br>") + 4)}</div>
          </div>
          <div style="padding:12px 16px;background:#f6f9fc;border-top:1px solid #eef3fb;text-align:right;">
            <button onclick="fechar_popup()" style="background:#072F4E;color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;">Fechar</button>
          </div>
        </div>
      </div>`;
  }
</script>