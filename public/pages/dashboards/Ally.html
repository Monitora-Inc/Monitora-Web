<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <title>Ally</title>
  <link rel="icon" href="../../assets/logos/logo_vetorizada.svg" type="image/x-icon">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="../../style/sidebar.css">
  <link rel="stylesheet" href="../../style/popup.css">
  <link rel="stylesheet" href="../../style/Ally.css">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


</head>

<body>
  <nav id="id_sidebar"></nav>
  <div id="id_info_kpis"></div>
  <div id="popup_screen"></div>
  <h1 class="titulo tooltip">
    Mapeamento global
    <span class="tooltip-text">Vis√£o geral da opera√ß√£o global dos datacenters em tempo real.</span>
  </h1>
  <div class="container">

    <div class="rankingDataCenter">
      <h2 class="subtitulo tooltip">
        Ranking Datacenters
        <span class="tooltip-text">Lista os datacenters ordenados pela sa√∫de operacional.</span>
      </h2>

      <div id="rankDatacenter" class="rankDatacenter">
      </div>
    </div>

    <div class="direita">
      <h2 class="subtitulo tooltip">
        Mapa dos datacenters
        <span class="tooltip-text">Cada ponto representa um datacenter e sua cor indica o estado atual.</span>
      </h2>
      <div id="map" class="mapLeaflet">
        <div id="popupFixo" class="popup-fixo"></div>
      </div>

      <div id="grafico_radar" class="grafico_radar">
        <div class="grafico_esquerda">
          <h3 class="tooltip">
            Gr√°fico comparativo
            <span class="tooltip-text">Compara a sa√∫de atual do datacenter versus a √∫ltima leitura.</span>
          </h3>
          <div class="card">
            <select id="selectDataCenter" onchange="mudarDatacenter()">
            </select>
            <div class="kpis">
              <p class="tooltip">Sa√∫de:<span id="Saude"></span>%
                <span class="tooltip-text">Indicador geral que combina CPU, RAM, Disco e Rede.</span>
              </p>
              <p class="tooltip">Rede: <span id="Rede"></span>%
                <span class="tooltip-text">Uso da banda de rede em rela√ß√£o ao limite m√°ximo.</span>
              </p>
              <p class="tooltip">Disco: <span id="Disco"></span>%
                <span class="tooltip-text">Uso do armazenamento f√≠sico do datacenter.</span>
              </p>
              <p class="tooltip">CPU: <span id="Cpu"></span>%
                <span class="tooltip-text">Carga atual de processamento do datacenter.</span>
              </p>
              <p class="tooltip">RAM: <span id="Ram"></span>%
                <span class="tooltip-text">Porcentagem da mem√≥ria sendo utilizada.</span>
              </p>

            </div>
          </div>
        </div>
        <canvas id="radarChart" class="grafico"></canvas>
      </div>
    </div>
  </div>
  <button onclick="popUp_IA()" class="logo_Ia tooltip" id="logoIa">
    <img src="../../assets/logos/logo_vetorizada.svg" alt="">
    <span class="tooltip-text">Dicas da IA.</span>
  </button>
  <div class="popup_IA desativada" id="popUpIA">
    <button onclick="popUp_fechar()" class="fechar_popUp"><img src="../../Images/voltar-branco.svg" alt=""></button>
    <h2>Dicas IA Monitora</h2>
    <div class="MensagemIA" id="MensagemIA">
    </div>
  </div>

  <footer>
    <div class="dashButtons" id="footerButons">
    </div>
    <p>Developed by <a href="https://www.linkedin.com/in/ally-awada">AllyAwada</a></p>
  </footer>
</body>

</html>

<script src="../../js/sidebar.js"></script>
<script src="../../js/popups.js"></script>
<script src="../../js/verificacaoPermissoes.js"></script>
<script>
  if (sessionStorage.empresaCnpj == undefined) {
    listarPermissoesReload();
    verificarPermissoesSideBar();
    setInterval(executarVerificacaoPermissoes, 30000);
  }

  function executarVerificacaoPermissoes() {
    if (sessionStorage.empresaCnpj == undefined) {
      listarPermissoesReload();
      verificarPermissoesSideBar();
    }
  }

  if (sessionStorage.empresaCnpj == undefined) {
    verificarPermissoesSideBar();
  }


  var radarChartInstance;
  var datacenters = [];
  var datacentersAnteriores = [];
  var mensagemdaia = "";
  async function buscarDados() {
    try {
      const caminho = `${sessionStorage.empresaId}%2Fglobal%2Fsnapshots%2F`;
      const resAnterior = await fetch(`/bucket/read/${caminho}/1`);
      if (!resAnterior.ok) throw new Error("Erro ao buscar snapshot anterior: " + resAnterior.status);

      const jsonAnterior = await resAnterior.json();
      const rowsAnt = jsonAnterior.rows;

      console.log("Rows anteriores:", rowsAnt);
      for (let d of rowsAnt) {
        datacentersAnteriores.push({
          cor: d.cor,
          Cpu: Number(d.cpu).toFixed(2),
          diferenca: Number(d.diferenca).toFixed(2),
          Disco: Number(d.disco).toFixed(2),
          IdDataCenter: d.idDataCenter,
          Ram: Number(d.ram).toFixed(2),
          RedeMb: Number(d.redeMb).toFixed(2),
          RedeMbS: Number(d.redeMbS).toFixed(2),
          Saude: Number(d.saude).toFixed(2),
          Timestamp: d.timestamp,
          up: Boolean(d.up)
        });
      }

      const resAtual = await fetch(`/bucket/read/${caminho}/0`);
      if (!resAtual.ok) throw new Error("Erro ao buscar snapshot atual: " + resAtual.status);

      const jsonAtual = await resAtual.json();
      const rowsAtual = jsonAtual.rows;

      for (let d of rowsAtual) {
        datacenters.push({
          cor: d.cor,
          Cpu: Number(d.cpu).toFixed(2),
          diferenca: Number(d.diferenca).toFixed(2),
          Disco: Number(d.disco).toFixed(2),
          IdDataCenter: d.idDataCenter,
          Ram: Number(d.ram).toFixed(2),
          RedeMb: Number(d.redeMb).toFixed(2),
          RedeMbS: Number(d.redeMbS).toFixed(2),
          Saude: Number(d.saude).toFixed(2),
          Timestamp: d.timestamp,
          up: Boolean(d.up)
        });
      }
      console.log("Datacenters atuais:", datacenters);

      await Promise.all(
        datacenters.map(async (dc, idx) => {
          try {
            const res = await fetch(`/datacenters/buscarLngLatNomeDatacenter/${dc.IdDataCenter}`);
            if (!res.ok) throw new Error("Erro ao buscar info do datacenter: " + res.status);

            const info = await res.json();

            datacenters[idx].nome = info[0].nome;
            datacenters[idx].lat = info[0].latitude;
            datacenters[idx].lng = info[0].longitude;

          } catch (erro) {
            console.log("Erro ao buscar detalhe do DC:", erro);
          }
        })
      );

      const resIA = await fetch(`/bobia/perguntar`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          prompt: `
          Voc√™ √© uma intelig√™ncia especializada em an√°lise de infraestrutura distribu√≠da. 
          Os dados recebidos s√£o snapshots globais.
          M√©tricas atuais: ${JSON.stringify(datacenters)}
          M√©tricas da √∫ltima leitura: ${JSON.stringify(datacentersAnteriores)}
          Com base nisso, fa√ßa:
          1. An√°lise completa do estado geral da opera√ß√£o global.
          2. Identifica√ß√£o de datacenters com risco iminente.
          3. Anomalias e comportamento fora do padr√£o.
          4. Recomenda√ß√£o de redistribui√ß√£o de carga.
          5. Compara√ß√£o entre datacenters: melhor e pior.
          6. Sugest√µes para melhorar performance e capacidade.
          7. Riscos operacionais prov√°veis nas pr√≥ximas horas.
          8. Oportunidades de otimiza√ß√£o (CPU/Disco/Rede).
          9. Pontos cr√≠ticos com a√ß√£o imediata.
          10. Insight final geral.
          Use linguagem clara, objetiva e curta.
          
          Para pular linhas ultilize de <br>
          para deixar algo em negrito ultilize <b>
          N√£o ultilize nada alem disso e responda de maneira mais simples para uma visualiza√ß√£o r√°pida
          `
        })
      });

      if (!resIA.ok) throw new Error("Erro IA: " + resIA.status);

      const respostaIA = await resIA.json();
      mensagemdaia = respostaIA.resultado;
      popUp_IA();
    } catch (erro) {
      console.error("Erro geral:", erro);
    }
  }
  function rankingDataCenter() {
    rankDatacenter.innerHTML = "";


    for (let i = 0; i < datacenters.length; i++) {
      console.log(datacenters[i])
      let estado = "";
      let iconStatus = "";

      if (datacenters[i].Saude >= 90) {
        estado = "ok";
        iconStatus = "ok.svg";
      } else if (datacenters[i].Saude >= 70) {
        estado = "alerta";
        iconStatus = "alerta.svg";
      } else {
        estado = "critico";
        iconStatus = "critico.svg";
      }
      let clsComparativo = datacenters[i].up ? "comparativo_up" : "comparativo_down";
      let iconComparativo = datacenters[i].up ? "lineUp.svg" : "lineDown.svg";

      rankDatacenter.innerHTML += `
      <div class="popup-dc" onclick="dashDC(${i})">
        <div class="status status_${estado}">
          <img src="../../Images/PopUpsDash/${iconStatus}" alt="">
          </div>
          <div class="contentDc">
            <div class="first">
              <img class="icon" src="../../Images/PopUpsDash/iconDc.svg" alt="">
              <p>${datacenters[i].nome}</p>
              </div>
              <div class="seccond seccond_${estado}">
                <h3 class="kpi tooltip">${datacenters[i].Saude}%
                  <span class="tooltip-text">Sa√∫de do datacenter.</span>
                </h3>
                <section class="comparativo ${clsComparativo}">
                  <p class="kpi tooltip">
                  <span class="tooltip-text">Diferen√ßa da ultima leitura da sa√∫de do datacenter.</span>
                    <img src="../../Images/PopUpsDash/${iconComparativo}" alt="">
                  ${datacenters[i].diferenca}%
              </p>
              <p>vs √∫ltima leitura</p>
            </section>
          </div>
        </div>
      </div>`;
    }
  }

  function dashDC(index) {
    sessionStorage.datacenter = JSON.stringify(datacenters[index]);
    window.location = "./Ally2.html";
  }

  function carregarSelectRadar() {
    const select = document.getElementById("selectDataCenter");
    select.innerHTML = "";

    datacenters.forEach((dc, index) => {
      select.innerHTML += `<option value="${index}">${dc.nome}</option>`;
    });

    mudarDatacenter();
  }

  function criarRadarInicial() {
    const ctx = document.getElementById("radarChart");

    radarChartInstance = new Chart(ctx, {
      type: "radar",
      data: {
        labels: ["Sa√∫de", "Disco", "RAM", "CPU", "Rede"],
        datasets: [
          {
            label: "Datacenter selecionado",
            data: [0, 0, 0, 0, 0],
            backgroundColor: "rgba(0, 0, 0, 0.15)",
            borderColor: "#000000",
            fill: true,
            borderWidth: 2
          },
          {
            label: "Ultima Leitura",
            data: [82, 70, 68, 80, 88],
            backgroundColor: "rgba(31, 84, 126, 0.15)",
            borderColor: "#1F547E",
            fill: true,
            borderWidth: 2
          }
        ]
      },
      options: {
        responsive: false,
        plugins: {
          legend: {
            labels: {
              color: "#1F547E"
            }
          }
        },
        scales: {
          r: {
            grid: {
              color: "#E5E4E2"
            },
            pointLabels: {
              color: "#1F547E"
            },
            suggestedMin: 0,
            suggestedMax: 100
          }
        }
      }
    });
  }

  function mudarDatacenter() {
    const index = document.getElementById("selectDataCenter").value;
    const dc = datacenters[index];
    const anterior = datacentersAnteriores[index];
    document.getElementById("Saude").innerText = dc.Saude;
    document.getElementById("Rede").innerText = dc.RedeMbS;
    document.getElementById("Disco").innerText = dc.Disco;
    document.getElementById("Cpu").innerText = dc.Cpu;
    document.getElementById("Ram").innerText = dc.Ram;

    atualizarRadar(dc, anterior);
  }

  function atualizarRadar(dc, anterior) {
    radarChartInstance.data.datasets[0].label = dc.nome;
    radarChartInstance.data.datasets[0].data = [
      dc.Saude,
      dc.Disco,
      dc.Ram,
      dc.Cpu,
      dc.RedeMbS
    ];

    radarChartInstance.data.datasets[1].data = [
      anterior.Saude,
      anterior.Disco,
      anterior.Ram,
      anterior.Cpu,
      anterior.RedeMbS
    ];

    radarChartInstance.data.datasets[0].backgroundColor = dc.cor + "33";
    radarChartInstance.data.datasets[0].borderColor = dc.cor;

    radarChartInstance.update();
  }

  function popUp_IA() {
    MensagemIA.innerHTML = `<p>${mensagemdaia}</p>`;
    popUpIA.classList.remove("desativada");
    popUpIA.classList.add("ativada");
    setTimeout(() => { logoIa.onclick = popUp_fechar }, 800)
  }

  function popUp_fechar() {
    MensagemIA.innerHTML = "";
    popUpIA.classList.remove("ativada");
    popUpIA.classList.add("desativada");
    setTimeout(() => { logoIa.onclick = popUp_IA }, 800)
  }

  window.onload = () => {
    popup_carregar();
    preencherKpisServidoresAlertas();
    listarPermissoesReload();
    buscarDados().then(() => {
      popup_screen.innerHTML = ``;
      rankingDataCenter();
      criarRadarInicial();
      carregarSelectRadar();
      popUpMapa();
    });
  };
</script>

<script>
  // Inicializa o mapa no centro do mundo
  var map = L.map('map', {
    zoomControl: false,       // remove o controle de zoom
    attributionControl: false // remove cr√©ditos extras
  }).setView([20, 0], 2);

  // Tile minimalista igual ao mockup
  L.tileLayer('https://tiles.stadiamaps.com/tiles/alidade_smooth/{z}/{x}/{y}{r}.png?api_key=b10e7203-2b91-4e06-b879-f2aac1c2af42', {
    maxZoom: 20
  }).addTo(map);

  // Fun√ß√£o dos marcadores estilo bolinha colorida
  function marker(color, nome) {
    return L.divIcon({
      className: "",
      html: `<div class="marker-dot tooltip" style="background:${color}">
          <span class="tooltip-text">${nome}</span>
        </div>`,
      iconSize: [16, 16],
      iconAnchor: [8, 8]
    });
  }



  // POPUP MODERNO E BONITO PARA O MAPA
  function criarPopupBonito(dc) {
    return `
    <div class="popup-card">
      <div class="popup-header">
        <div class="popup-icon">üì°</div>
        <div>
          <h3 class="popup-title">${dc.nome}</h3>
          <p class="popup-sub ${dc.Saude >= 90 ? "ok" : dc.Saude >= 70 ? "alerta" : "critico"}">${dc.Saude}% de sa√∫de</p>
        </div>
      </div>

      <div class="popup-row">
        <span>CPU</span>
        <p>${dc.Cpu}%</p>
      </div>

      <div class="popup-row">
        <span>RAM</span>
        <p>${dc.Ram}%</p>
      </div>

      <div class="popup-row">
        <span>Uso de rede</span>
        <p>${dc.RedeMb}Mb</p>
      </div>

      <div class="popup-row">
        <span>Disco</span>
        <p>${dc.Disco}%</p>
      </div>

      <div class="popup-status ${dc.Saude >= 90 ? "ok" : dc.Saude >= 70 ? "alerta" : "critico"}">
        ${dc.Saude >= 90 ? "Operando normalmente" :
        dc.Saude >= 70 ? "Aten√ß√£o ‚Äî alta carga" :
          "Cr√≠tico ‚Äî risco de falhas"}
      </div>
    </div>
  `;
  }

  const popupOptions = {
    className: "popup-custom",
    closeButton: false,
    offset: [0, -5]
  };

  function popUpMapa() {
    datacenters.forEach(dc => {
      const markerInstance = L.marker([dc.lat, dc.lng], { icon: marker(dc.cor, dc.nome) }).addTo(map);

      markerInstance.on("click", () => {
        const html = criarPopupBonito(dc);

        const divFixa = document.getElementById("popupFixo");
        divFixa.innerHTML = html;
        divFixa.classList.remove("ok", "alerta", "critico")
        divFixa.classList.add(`${dc.Saude >= 90 ? "ok" : dc.Saude >= 70 ? "alerta" : "critico"}`)
        divFixa.style.display = "block";
      });
    });
  }
</script>
