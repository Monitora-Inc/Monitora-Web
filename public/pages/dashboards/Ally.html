<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <title>Ally</title>
  <link rel="icon" href="../../assets/logos/logo_vetorizada.svg" type="image/x-icon">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="../../style/sidebar.css">
  <link rel="stylesheet" href="../../style/popup.css">
  <link rel="stylesheet" href="../../style/Ally.css">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


</head>

<body>
  <nav id="id_sidebar"></nav>
  <div id="id_info_kpis"></div>
  <div id="popup_screen"></div>
  <h1 class="titulo">Mapeamento global</h1>
  <div class="container">

    <div class="rankingDataCenter">
      <h2 class="subtitulo">Ranking Datacenters</h2>
      <div id="rankDatacenter" class="rankDatacenter">
      </div>
    </div>

    <div class="direita">
      <h2 class="subtitulo">Mapa dos datacenters</h2>
      <div id="map" class="mapLeaflet">
        <div id="popupFixo" class="popup-fixo"></div>
      </div>

      <div id="grafico_radar" class="grafico_radar">
        <div class="grafico_esquerda">
          <h3>GrÃ¡fico comparativo</h3>
          <div class="card">
            <select id="selectDataCenter" onchange="mudarDatacenter()">
            </select>
            <div class="kpis">
              <p>Saude: <span id="Saude"></span>%</p>
              <p>Uso de rede: <span id="Rede"></span>%</p>
              <p>Disco: <span id="Disco"></span>%</p>
              <p>CPU: <span id="Cpu"></span>%</p>
              <p>RAM: <span id="Ram"></span>%</p>
            </div>
          </div>
        </div>
        <canvas id="radarChart" class="grafico"></canvas>
      </div>
    </div>
  </div>
  <button onclick="popUp_IA()" class="logo_Ia" id="logoIa"><img src="../../assets/logos/logo_vetorizada.svg"
      alt=""></button>

  <div class="popup_IA desativada" id="popUpIA">
    <button onclick="popUp_fechar()" class="fechar_popUp"><img src="../../Images/voltar-branco.svg" alt=""></button>
    <h2>Dicas IA Monitora</h2>
    <div class="MensagemIA" id="MensagemIA">
    </div>
  </div>

  <footer>
    <div class="dashButtons">
      <a href="./home.html"><img style="border-radius: 0 !important" src="../../Images/home.svg" alt=""></a>
      <a href="./Ally.html"><img src="../../Images/Colaboradores/Colaborador1.svg" alt=""></a>
      <a href="./Gustavo.html"><img src="../../Images/Colaboradores/Colaborador2.svg" alt=""></a>
      <a href="./Leonardo.html"><img src="../../Images/Colaboradores/Colaborador3.svg" alt=""></a>
      <a href="./Maria.html"><img src="../../Images/Colaboradores/Colaborador4.svg" alt=""></a>
      <a href="./Pedro.html"><img src="../../Images/Colaboradores/Colaborador5.svg" alt=""></a>
    </div>
    <p>Developed by <a href="https://www.linkedin.com/in/ally-awada">AllyAwada</a></p>
  </footer>
</body>

</html>

<script src="../../js/sidebar.js"></script>
<script src="../../js/popups.js"></script>
<script src="../../js/verificacaoPermissoes.js"></script>
<script>
  if (sessionStorage.empresaCnpj == undefined) {
    listarPermissoesReload();
    verificarPermissoesSideBar();
    setInterval(executarVerificacaoPermissoes, 30000);
  }

  function executarVerificacaoPermissoes() {
    if (sessionStorage.empresaCnpj == undefined) {
      listarPermissoesReload();
      verificarPermissoesSideBar();
    }
  }

  if (sessionStorage.empresaCnpj == undefined) {
    verificarPermissoesSideBar();
  }


  var radarChartInstance;
  var datacenters = [];
  async function buscarDados() {
    var caminho = `${sessionStorage.empresaId}%2Fglobal%2Fsnapshots%2F`;
    return fetch(`/bucket/read/${caminho}/0`, {
      method: 'GET',
      headers: {
        "Content-Type": "application/json"
      }
    }).then(function (response) {
      if (!response.ok) {
        throw new Error("Erro ao buscar snapshot: " + response.status);
      }
      return response.json()
    }).then(function (data) {

      var dados = data.rows;
      var retorno = [];
      for (let i = 0; i < dados.length; i++) {
        dataAtual = dados[i];
        var temp = {
          cor: dataAtual.cor,
          Cpu: Number(dataAtual.cpu).toFixed(2),
          diferenca: Number(dataAtual.diferenca).toFixed(2),
          Disco: Number(dataAtual.disco).toFixed(2),
          IdDataCenter: dataAtual.idDataCenter,
          Ram: Number(dataAtual.ram).toFixed(2),
          Rede: Number(dataAtual.rede).toFixed(2),
          Saude: Number(dataAtual.saude).toFixed(2),
          Timestamp: dataAtual.timestamp,
          up: Boolean(dataAtual.up)
        }
        datacenters.push(temp)
      }

      for (let i = 0; i <= datacenters.length - 1; i++) {
        var dcId = datacenters[i].IdDataCenter;
        return fetch(`/datacenters/buscarLngLatNomeDatacenter/${dcId}`, {
          method: 'GET',
          headers: {
            "Content-Type": "application/json"
          }
        }).then(function (response) {
          if (!response.ok) {
            throw new Error(`Erro HTTP: ${response.status}`);
          }
          return response.json();
        }).then(function (dadosDc) {
          datacenters[i].nome = dadosDc[0].nome;
          datacenters[i].lat = dadosDc[0].latitude;
          datacenters[i].lng = dadosDc[0].longitude;
        }).catch(function (resposta) {
          console.log(`#ERRO: ${resposta}`);
        });
        console.log(datacenters);
      }
    }).catch(function (resposta) {
      console.log(`#ERRO: ${resposta}`);
    });
  }

  function rankingDataCenter() {
    rankDatacenter.innerHTML = "";


    for (let i = 0; i < datacenters.length; i++) {
      console.log(datacenters[i])
      let estado = "";
      let iconStatus = "";

      if (datacenters[i].Saude >= 90) {
        estado = "ok";
        iconStatus = "ok.svg";
      } else if (datacenters[i].Saude >= 70) {
        estado = "alerta";
        iconStatus = "alerta.svg";
      } else {
        estado = "critico";
        iconStatus = "critico.svg";
      }
      let clsComparativo = datacenters[i].up ? "comparativo_up" : "comparativo_down";
      let iconComparativo = datacenters[i].up ? "lineUp.svg" : "lineDown.svg";

      rankDatacenter.innerHTML += `
      <div class="popup-dc" onclick="dashDC(${i})">
        <div class="status status_${estado}">
          <img src="../../Images/PopUpsDash/${iconStatus}" alt="">
        </div>
        <div class="contentDc">
          <div class="first">
            <img class="icon" src="../../Images/PopUpsDash/iconDc.svg" alt="">
              <p>${datacenters[i].nome}</p>
          </div>
          <div class="seccond seccond_${estado}">
            <h3 class="kpi">${datacenters[i].Saude}%</h3>
            <section class="comparativo ${clsComparativo}">
              <p class="kpi">
                <img src="../../Images/PopUpsDash/${iconComparativo}" alt="">
                  ${datacenters[i].diferenca}%
              </p>
              <p>vs Ãºltima leitura</p>
            </section>
          </div>
        </div>
      </div>`;
    }
  }

  function dashDC(index) {
    sessionStorage.datacenter = JSON.stringify(datacenters[index]);
    window.location = "./Ally2.html";
  }

  function carregarSelectRadar() {
    const select = document.getElementById("selectDataCenter");
    select.innerHTML = "";

    datacenters.forEach((dc, index) => {
      select.innerHTML += `<option value="${index}">${dc.nome}</option>`;
    });

    mudarDatacenter();
  }

  function criarRadarInicial() {
    const ctx = document.getElementById("radarChart");

    radarChartInstance = new Chart(ctx, {
      type: "radar",
      data: {
        labels: ["SaÃºde", "Disco", "RAM", "CPU", "Rede"],
        datasets: [
          {
            label: "Datacenter selecionado",
            data: [0, 0, 0, 0, 0],
            backgroundColor: "rgba(0, 0, 0, 0.15)",
            borderColor: "#000000",
            fill: true,
            borderWidth: 2
          },
          {
            label: "Limites",
            data: [82, 70, 68, 80, 88],
            backgroundColor: "rgba(31, 84, 126, 0.15)",
            borderColor: "#1F547E",
            fill: true,
            borderWidth: 2
          }
        ]
      },
      options: {
        responsive: false,
        plugins: {
          legend: {
            labels: {
              color: "#1F547E"
            }
          }
        },
        scales: {
          r: {
            grid: {
              color: "#E5E4E2"
            },
            pointLabels: {
              color: "#1F547E"
            },
            suggestedMin: 0,
            suggestedMax: 100
          }
        }
      }
    });
  }

  function mudarDatacenter() {
    const index = document.getElementById("selectDataCenter").value;
    const dc = datacenters[index];

    document.getElementById("Saude").innerText = dc.Saude;
    document.getElementById("Rede").innerText = dc.Rede;
    document.getElementById("Disco").innerText = dc.Disco;
    document.getElementById("Cpu").innerText = dc.Cpu;
    document.getElementById("Ram").innerText = dc.Ram;

    atualizarRadar(dc);
  }

  function atualizarRadar(dc) {
    radarChartInstance.data.datasets[0].label = dc.nome;
    radarChartInstance.data.datasets[0].data = [
      dc.Saude,
      dc.Disco,
      dc.Ram,
      dc.Cpu,
      dc.Rede
    ];

    radarChartInstance.data.datasets[0].backgroundColor = dc.cor + "33";
    radarChartInstance.data.datasets[0].borderColor = dc.cor;

    radarChartInstance.update();
  }

  var mensagemdaia = `<p>ðŸ”„ RedistribuiÃ§Ã£o recomendada: mover 20% da carga do DC Paulista para o DC Orlando <br>âš  Anomalia detectada: aumento de 12% de latÃªncia no DC RÃºssia nas Ãºltimas 3h <br>ðŸŸ© Orlando estÃ¡ apto para receber novas instÃ¢ncias <br>ðŸª« Paulista perto do limite de disco (82%)</p>`;
  function popUp_IA() {
    MensagemIA.innerHTML = `${mensagemdaia}`;
    popUpIA.classList.remove("desativada");
    popUpIA.classList.add("ativada");
    setTimeout(() => { logoIa.onclick = popUp_fechar }, 800)
  }

  function popUp_fechar() {
    MensagemIA.innerHTML = "";
    popUpIA.classList.remove("ativada");
    popUpIA.classList.add("desativada");
    setTimeout(() => { logoIa.onclick = popUp_IA }, 800)
  }

  window.onload = () => {
    listarPermissoesReload();
    buscarDados().then(() => {
      rankingDataCenter();
      criarRadarInicial();
      carregarSelectRadar();
      popUpMapa();
    });
  };
</script>

<script>
  // Inicializa o mapa no centro do mundo
  var map = L.map('map', {
    zoomControl: false,       // remove o controle de zoom
    attributionControl: false // remove crÃ©ditos extras
  }).setView([20, 0], 2);

  // Tile minimalista igual ao mockup
  L.tileLayer('https://tiles.stadiamaps.com/tiles/alidade_smooth/{z}/{x}/{y}{r}.png', {
    maxZoom: 20
  }).addTo(map);

  // FunÃ§Ã£o dos marcadores estilo bolinha colorida
  function marker(color) {
    return L.divIcon({
      className: "",
      html: `<div class="marker-dot" style="background:${color}"></div>`,
      iconSize: [16, 16],
      iconAnchor: [8, 8]
    });
  }



  // POPUP MODERNO E BONITO PARA O MAPA
  function criarPopupBonito(dc) {
    return `
    <div class="popup-card">
      <div class="popup-header">
        <div class="popup-icon">ðŸ“¡</div>
        <div>
          <h3 class="popup-title">${dc.nome}</h3>
          <p class="popup-sub ${dc.Saude >= 90 ? "ok" : dc.Saude >= 70 ? "alerta" : "critico"}">${dc.Saude}% de saÃºde</p>
        </div>
      </div>

      <div class="popup-row">
        <span>CPU</span>
        <p>${dc.Cpu}%</p>
      </div>

      <div class="popup-row">
        <span>RAM</span>
        <p>${dc.Ram}%</p>
      </div>

      <div class="popup-row">
        <span>Rede</span>
        <p>${dc.Rede}%</p>
      </div>

      <div class="popup-row">
        <span>Disco</span>
        <p>${dc.Disco}%</p>
      </div>

      <div class="popup-status ${dc.Saude >= 90 ? "ok" : dc.Saude >= 70 ? "alerta" : "critico"}">
        ${dc.Saude >= 90 ? "Operando normalmente" :
        dc.Saude >= 70 ? "AtenÃ§Ã£o â€” alta carga" :
          "CrÃ­tico â€” risco de falhas"}
      </div>
    </div>
  `;
  }

  const popupOptions = {
    className: "popup-custom",
    closeButton: false,
    offset: [0, -5]
  };

  function popUpMapa() {
    datacenters.forEach(dc => {
      const markerInstance = L.marker([dc.lat, dc.lng], { icon: marker(dc.cor) }).addTo(map);

      markerInstance.on("click", () => {
        const html = criarPopupBonito(dc);

        const divFixa = document.getElementById("popupFixo");
        divFixa.innerHTML = html;
        divFixa.classList.remove("ok", "alerta", "critico")
        divFixa.classList.add(`${dc.Saude >= 90 ? "ok" : dc.Saude >= 70 ? "alerta" : "critico"}`)
        divFixa.style.display = "block";
      });
    });
  }
</script>