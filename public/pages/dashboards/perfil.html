<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil</title>
    <link rel="icon" href="../../assets/logos/logo_vetorizada.svg" type="image/x-icon">
    <link rel="stylesheet" href="../../style/sidebar.css">
    <link rel="stylesheet" href="../../style/essencial.css">
    <link rel="stylesheet" href="../../style/filtros.css">
    <link rel="stylesheet" href="../../style/perfil.css">
    <link rel="stylesheet" href="../../style/popup.css">
</head>

<body onload="infoPerfil()">
    <nav id="id_sidebar"></nav>
    <div id="id_info_kpis"></div>
    <div id="popup_screen"></div>

    <div class="page_content">
        <div class="perfil">
            <div class="perfil_container" id="perfil">
                
            </div>
        </div>
    </div>
</body>

</html>
<script src="../../js/sidebar.js"></script>
<script src="../../js/popups.js"></script>
<script src="../../js/verificacaoPermissoes.js"></script>

<script>
    if(sessionStorage.empresaCnpj == undefined && sessionStorage.empresaId != 1) {
        verificarPermissoesSideBar();
    }

    function infoPerfil() {
        if (sessionStorage.userNome != null) {
            perfil.innerHTML = `
            <img src="../../assets/fotosPerfil/${sessionStorage.fotoUser}" alt="Foto de perfil" onclick="popup_editar_foto()">
                <div class="perfil_informacoes">
                    <h1 id="perfil_nome">${sessionStorage.userNome} ${sessionStorage.userSobrenome}</h1>
                    <h2 id="perfil_cargo">${sessionStorage.cargo}</h2>
                    <h3 id="perfil_email">${sessionStorage.userEmail}</h3>
                    <h4 id="perfil_telefone">${mascaraTelefone(sessionStorage.userTelefone)}</h4>
                    <button onclick="popup_editar_informacoes()">Editar Informações</button>
                </div>
            `
        } else {
            perfil.innerHTML = `
            <img src="../../assets/fotosPerfil/${sessionStorage.empresaFoto}" alt="Foto de perfil" onclick="popup_editar_foto()">
                <div class="perfil_informacoes">
                    <h1 id="perfil_nome">${sessionStorage.empresaNome}</h1>
                    <h2 id="perfil_cargo">Empresa<h2>
                    <h3 id="perfil_cnpj">${sessionStorage.empresaCnpj}</h3>
                    <button onclick="popup_confirmar_senha()">Editar Informações</button>
                </div>
            `
        }
    }

    async function confirmar_senha(){
         mensagem_erro.innerHTML = ``;
        if (sessionStorage.userNome != null){

                let usuarioEmail = sessionStorage.userEmail;
                let usuarioSenha = await iptSenha.value;

                if (!usuarioSenha) {
                    mensagem_erro.innerHTML = `Preencha o campo de senha!`;
                    return;
                }

                let respostaLogin = await fetch(`/usuarios/confirmarSenha/${sessionStorage.userEmail}/${usuarioSenha}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!respostaLogin.ok) {
                    respostaLogin.text().then(texto => {
                        mensagem_erro.innerHTML = `<p>${texto}</p>`;
                    });
                    return;
                }

                let jsonLogin = await respostaLogin.json();

                if (jsonLogin.empresaAtiva == 0) {
                    mensagem_erro.innerHTML = `<p>Sua empresa está desativada</p>`;
                    return;
                } else if (jsonLogin.empresaAprovada == 0) {
                    mensagem_erro.innerHTML = `<p>Sua empresa ainda não foi aprovada pelos administradores</p>`;
                    return;
                }
                sessionStorage.userId = jsonLogin.userId;
                sessionStorage.userNome = jsonLogin.userNome;
                sessionStorage.userSobrenome = jsonLogin.userSobrenome;
                sessionStorage.userEmail = jsonLogin.userEmail;
                sessionStorage.userTelefone = jsonLogin.userTelefone;
                sessionStorage.fotoUser = jsonLogin.fotoUser;
                sessionStorage.cargoId = jsonLogin.cargoId;
                sessionStorage.cargo = jsonLogin.cargo;
                sessionStorage.empresaId = jsonLogin.empresaId;
                sessionStorage.empresaNome = jsonLogin.empresaNome;
                popup_editar_informacoes();
            
        } else { 
                let empresaSenha = await iptEmpresaSenha.value;

                if (!empresaSenha) {
                    mensagem_erro.innerHTML = `Preencha o campo de senha!`;

                    return;
                }

                let respostaLogin = await fetch(`/empresas/confirmarSenha/${sessionStorage.empresaCnpj}/${empresaSenha}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!respostaLogin.ok) {
                    respostaLogin.text().then(texto => {
                        mensagem_erro.innerHTML = `<p>${texto}</p>`;
                    });

                    return;
                } else {
                    mensagem_erro.innerHTML = "Senha correta!"
                }
        }
    }

    function editarPerfilUsuario() {
    
    let nomeUsuario = document.getElementById('ipt_nome').value.trim();
    let sobrenomeUsuario = document.getElementById('ipt_sobrenome').value.trim();
    let emailUsuario = document.getElementById('ipt_email').value;
    let telefoneUsuario = document.getElementById('ipt_telefone').value;
    let senhaUsuario = document.getElementById('ipt_senha').value;
    let confirmacao_senhaUsuario = document.getElementById('ipt_confirmar_senha').value;

    // Validações obrigatórias
    if (nomeUsuario === "") {
        mensagem_erro.innerHTML="O campo nome está em branco.";
        return;
    }
    if (sobrenomeUsuario === "") {
        mensagem_erro.innerHTML="O campo sobrenome está em branco.";
        return;
    }
    if (emailUsuario === "") {
        mensagem_erro.innerHTML="O campo email está em branco.";
        return;
    }

    // Validações condicionais
    if (telefoneUsuario !== "" && !/^\(\d{2}\) \d{5}-\d{4}$/.test(telefoneUsuario)) {
        mensagem_erro.innerHTML="Formato de telefone inválido. Use: (11) 99999-9999";
        return;
    }
    if (senhaUsuario !== "" && (senhaUsuario.length < 8 || !/[A-Za-z]/.test(senhaUsuario) || !/\d/.test(senhaUsuario))) {
        mensagem_erro.innerHTML="A senha deve ter pelo menos 8 caracteres, incluindo letras e números";
        return;
    }
    if (confirmacao_senhaUsuario !== "" && senhaUsuario !== confirmacao_senhaUsuario) {
        mensagem_erro.innerHTML="As senhas não coincidem";
        return;
    }
    
    telefoneUsuario = telefoneUsuario.replace(/\D/g, '');

    fetch("/usuarios/editarPerfil", {
        
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            idServer: sessionStorage.userId,
            nomeServer: nomeUsuario,
            sobrenomeServer: sobrenomeUsuario,
            emailServer: emailUsuario,
            telefoneServer: telefoneUsuario,
            senhaServer: senhaUsuario
        })
    })
    .then(resposta => {
        if (resposta.ok) {
            return resposta.json();
            
        } else {
            return resposta.text().then(text => { throw new Error(text) });
        }
    })
    .then(data => {
        console.log("Sucesso:", data);
        mensagem_erro.innerHTML="Alteração realizada com sucesso!";
        sessionStorage.userNome = nomeUsuario;
        sessionStorage.userSobrenome = sobrenomeUsuario;
        sessionStorage.userEmail = emailUsuario;
        sessionStorage.userTelefone = telefoneUsuario;
        
        setTimeout(() => {
            window.location.reload();
        }, 2000);
    })
    .catch(erro => {
        console.error(`#ERRO: ${erro}`);
        mensagem_erro.innerHTML= erro;
    });
}
</script>