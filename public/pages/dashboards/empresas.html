<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Servidores</title>
    <link rel="icon" href="../../assets/logos/logo_vetorizada.svg" type="image/x-icon">
    <link rel="stylesheet" href="../../style/sidebar.css">
    <link rel="stylesheet" href="../../style/filtros.css">
    <link rel="stylesheet" href="../../style/essencial.css">
    <link rel="stylesheet" href="../../style/tela_empresas.css">
    <link rel="stylesheet" href="../../style/popup.css">
</head>

<body onload="carregarEmpresas()">
    <nav id="id_sidebar"></nav>
    <div id="id_info_kpis"></div>
    <div id="popup_screen"></div>


    <div class="page_content">
        <!-- Filtros de persquisa -->
        <!-- Filtros de persquisa -->
        <div class="filtros">
            <img class="icones_filtros icone_filtro" alt="">
            <select id="id_filtro" onchange="">
                <option value="filtro_ordem_alfabetica">Ordem Alfabética</option>
                <option value="filtro_ordem_numerica">Ordem Númerica</option>
            </select>
            <img class="icones_filtros icone_pesquisar" alt="">
            <input type="search" placeholder="Digite para pesquisar">
        </div>
        <!-- Lista de servidores -->
        <h2 class="lista_titulo">Empresas</h2>
        <div class="container_cards_empresas" id="cardsEmpresas">

        </div>
    </div>

    </div>
</body>

</html>
<script src="../../js/sidebar.js"></script>
<script src="../../js/popups.js"></script>
<script src="../../js/verificacaoPermissoes.js"></script>

<script>
    function carregarEmpresas() {
        fetch(`/empresas/buscarEmpresas`, {
            method: 'GET',
            headers: {
                "Content-Type": "application/json"
            }
        }).then(function (response) {
            if (!response.ok) {
                throw new Error(`Erro HTTP: ${response.status}`);
            }
            return response.json();
        }).then(function (dadosEmpresas) {
            console.log(dadosEmpresas);
            for (let i = 0; i < dadosEmpresas.length; i++) {
                if (dadosEmpresas[i].aprovada == 0) {
                    cardsEmpresas.innerHTML += `
                    <div class="card_empresa">
                    <div id="id_card_empresa_informacoes">
                        <div id="id_nomeEmpresa">${dadosEmpresas[i].nome}</div>
                        <div id="id_cnpjEmpresa">CNPJ: ${formatarCNPJ(dadosEmpresas[i].cnpj)}</div>
                        <div id="id_statusEmpresa">Status: <span class="pendente">Pendente</span></div>
                    </div>

                    <div id="id_card_empresa_botoes">
                        <button class="botao_aprovar" onclick="aprovarEmpresa(${dadosEmpresas[i].idEmpresa})"></button>
                        <button class="botao_rejeitar" onclick="reprovarEmpresa(${dadosEmpresas[i].idEmpresa})"></button>
                    </div>
                </div>`
                } else {
                    cardsEmpresas.innerHTML += `
                            <div class="card_empresa">
                            <div id="id_card_empresa_informacoes">
                                <div id="id_nomeEmpresa">${dadosEmpresas[i].nome}</div>
                                <div id="id_cnpjEmpresa">CNPJ: ${formatarCNPJ(dadosEmpresas[i].cnpj)}</div>
                                <div id="id_statusEmpresa">Status: <span class="aprovada">Aprovada</span></div>
                            </div>
                        
                            <div id="id_card_empresa_botoes">
                                <button class="botao_aprovar" onclick="aprovarEmpresa(${dadosEmpresas[i].idEmpresa})"></button>
                                <button class="botao_rejeitar" onclick="reprovarEmpresa(${dadosEmpresas[i].idEmpresa})"></button>
                            </div>
                        </div>`
                }
            }
        }).catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
        });
    }

    function formatarCNPJ(cnpj) {
        cnpj = cnpj.replace(/\D/g, ""); // remove tudo que não for número

        return cnpj.replace(
            /^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})$/,
            "$1.$2.$3/$4-$5"
        );
    }

    function aprovarEmpresa(id) {
        fetch(`/empresas/autorizarEmpresa/${id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
        }).then(function (response) {
            if (response.ok) {
                console.log(`Empresa ID ${id} aprovada com sucesso!`);

                location.reload();
            } else {
                console.error(`Falha ao aprovar a empresa de id ${id}. Status: ${response.status}`);
            }
        })
            .catch(function (error) {
                console.error("Erro de rede:", error);
            });
    }

    function reprovarEmpresa(id) {
        fetch(`/empresas/negarEmpresa/${id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
        }).then(function (response) {
            if (response.ok) {
                console.log(`Empresa ID ${id} reprovada com sucesso!`);

                location.reload();
            } else {
                console.error(`Falha ao reprovar a empresa de id ${id}. Status: ${response.status}`);
            }
        })
            .catch(function (error) {
                console.error("Erro de rede:", error);
            });
    }

</script>