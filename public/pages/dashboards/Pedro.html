<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <title>Pedro</title>
  <link rel="icon" href="../../assets/logos/logo_vetorizada.svg" type="image/x-icon">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="../../style/sidebar.css">
  <link rel="stylesheet" href="../../style/essencial.css">
  <link rel="stylesheet" href="../../style/filtros.css">
  <link rel="stylesheet" href="../../style/popup.css">
  <link rel="stylesheet" href="../../style/pedro.css">
</head>

<body onload="listarPermissoesReload(), preencherKpisServidoresAlertas()">
  <nav id="id_sidebar"></nav>
  <div id="id_info_kpis"></div>
  <div id="popup_screen"></div>

  <div class="page_content">
    <div id="grafico_overlay"></div>

    <!-- ======================================================== -->
    <!--                       HEADER                             -->
    <!-- ======================================================== -->
    <div class="header">
      <div class="server_info">
        <h1 id="server_nome"></h1>
        <h2 id="server_localizacao"></h2>
      </div>
      <div class="filtro_periodo">
        <input type="date" id="dataFiltro" onchange="selecionarData()" />
      </div>

    </div>

    <!-- ======================================================== -->
    <!--                       KPIS                               -->
    <!-- ======================================================== -->
    <div class="kpis">

      <!-- SA√öDE -->
      <div class="card_kpi">
        <div class="card_kpi_status atencao">
          <img src="../../assets/icons/icone_atencao.svg">
        </div>

        <div class="card_kpi_info">
          <div class="card_kpi_label">
            <img src="../../assets/icons/icone_coracao.svg" class="saude">
            <h3>Sa√∫de do CDN</h3>
          </div>

          <div class="card_kpi_metrica">
            <h1 class="atencao_texto" id="metrica_saude">62%</h1>

          </div>
        </div>
      </div>

      <!-- DISPONIBILIDADE -->
      <div class="card_kpi">
        <div class="card_kpi_status estavel">
          <img src="../../assets/icons/icone_positivo.svg">
        </div>

        <div class="card_kpi_info">
          <div class="card_kpi_label">
            <img src="../../assets/icons/icone_disponibilidade.svg" class="disponibilidade">
            <h3>Disponibilidade de Servi√ßo</h3>
          </div>

          <div class="card_kpi_metrica">
            <h1 class="estavel_texto" id="metrica_disponibilidade">99.4%</h1>
          </div>
        </div>
      </div>

      <!-- LAT√äNCIA -->
      <div class="card_kpi">
        <div class="card_kpi_status estavel">
          <img src="../../assets/icons/icone_positivo.svg">
        </div>

        <div class="card_kpi_info">
          <div class="card_kpi_label">
            <img src="../../assets/icons/icone_latencia.svg" class="latencia">
            <h3>Lat√™ncia M√©dia de Origem</h3>
          </div>

          <div class="card_kpi_metrica">
            <h1 class="estavel_texto" id="metrica_latencia">3ms</h1>
          </div>
        </div>
      </div>

      <!-- EFICI√äNCIA -->
      <div class="card_kpi">
        <div class="card_kpi_status critico">
          <img src="../../assets/icons/icone_negativo.svg">
        </div>

        <div class="card_kpi_info">
          <div class="card_kpi_label">
            <img src="../../assets/icons/icone_transferencia.svg" class="eficiencia">
            <h3>Efici√™ncia de Entrega</h3>
          </div>

          <div class="card_kpi_metrica">
            <h1 class="critico_texto" id="metrica_entrega">65.98%</h1>
            <div>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- ======================================================== -->
    <!--                       GR√ÅFICOS                           -->
    <!-- ======================================================== -->
    <div class="graficos">

      <!-- CACHE MISS -->
      <div class="box_grafico">
        <div class="header">
          <div class="label">
            <h1>Cache Miss</h1>
            <h2>√öltimo dia selecionado</h2>
          </div>

          <div class="configuracoes">
            <a class="tooltip icone_ampliar" onclick="expandirGrafico(this)">
              <span class="tooltiptext">Ampliar</span>
            </a>
            <a class="tooltip icone_tooltip"
              onclick="pop_up_info('Cache Miss (%)\n\nPercentual de requisi√ß√µes que n√£o foram atendidas pelo cache e precisaram buscar o conte√∫do no servidor de origem.\n\nPor que √© importante:\n‚Ä¢ Aumenta a lat√™ncia.\n‚Ä¢ Eleva o uso e custo da origem.\n‚Ä¢ Indica baixa efici√™ncia do cache.\n\nComo interpretar:\n‚Ä¢ Valores altos s√£o indesej√°veis.\n‚Ä¢ Linha vermelha = cr√≠tico.\n‚Ä¢ Linha amarela = aten√ß√£o.')">
              <span class="tooltiptext">O que √© isso?</span>
            </a>
          </div>
        </div>

        <div class="grafico">
          <div id="graficoCacheMiss" class="chart-container" data-chart="cacheMiss"></div>
        </div>
      </div>


      <!-- CACHE HIT -->
      <div class="box_grafico">
        <div class="header">
          <div class="label">
            <h1>Cache Hit</h1>
            <h2>√öltimo dia selecionado</h2>
          </div>

          <div class="configuracoes">
            <a class="tooltip icone_ampliar" onclick="expandirGrafico(this)">
              <span class="tooltiptext">Ampliar</span>
            </a>

            <a class="tooltip icone_tooltip"
              onclick="pop_up_info('Cache Hit (%)\n\nPercentual de requisi√ß√µes entregues diretamente pelo cache.\n\nPor que √© importante:\n‚Ä¢ Reduz a lat√™ncia.\n‚Ä¢ Reduz carga na origem.\n‚Ä¢ Melhora a experi√™ncia do usu√°rio.\n\nComo interpretar:\n‚Ä¢ Quanto maior, melhor.\n‚Ä¢ Linha vermelha indica valor cr√≠tico.\n‚Ä¢ Linha amarela indica tend√™ncia negativa.')">
              <span class="tooltiptext">O que √© isso?</span>
            </a>
          </div>
        </div>

        <div class="grafico">
          <div id="graficoCacheHit" class="chart-container" data-chart="cacheHit"></div>
        </div>
      </div>


      <!-- VOLUME DE REQUISI√á√ïES -->
      <div class="box_grafico">
        <div class="header">
          <div class="label">
            <h1>Volume de Requisi√ß√µes</h1>
            <h2>√öltimo dia selecionado</h2>
          </div>

          <div class="configuracoes">
            <a class="tooltip icone_ampliar" onclick="expandirGrafico(this)">
              <span class="tooltiptext">Ampliar</span>
            </a>

            <a class="tooltip icone_tooltip"
              onclick="pop_up_info('Volume de Requisi√ß√µes\n\nQuantidade total de requisi√ß√µes processadas pelo CDN.\n\nPor que √© importante:\n‚Ä¢ Revela padr√µes de uso.\n‚Ä¢ Identifica picos e comportamento dos usu√°rios.\n‚Ä¢ Auxilia no planejamento de capacidade.\n\nComo interpretar:\n‚Ä¢ Picos podem indicar eventos ou aumento de consumo.\n‚Ä¢ Quedas podem indicar baixa demanda ou falhas.')">
              <span class="tooltiptext">O que √© isso?</span>
            </a>
          </div>
        </div>

        <div class="grafico">
          <div id="graficoRequisicoes" class="chart-container" data-chart="req"></div>
        </div>
      </div>


      <!-- LAT√äNCIA PERCENTIL -->
      <div class="box_grafico">
        <div class="header">
          <div class="label">
            <h1>Lat√™ncia por Percentil</h1>
            <h2>√öltimo dia selecionado</h2>
          </div>

          <div class="configuracoes">
            <a class="tooltip icone_ampliar" onclick="expandirGrafico(this)">
              <span class="tooltiptext">Ampliar</span>
            </a>

            <a class="tooltip icone_tooltip"
              onclick="pop_up_info('Lat√™ncia por Percentil\n\nMede o tempo de resposta do CDN separando p50, p90 e p99.\n\nPor que √© importante:\n‚Ä¢ Avalia experi√™ncia real dos usu√°rios.\n‚Ä¢ Mostra estabilidade e consist√™ncia.\n‚Ä¢ Ajuda a identificar gargalos.\n\nComo interpretar:\n‚Ä¢ p50 = maioria das requisi√ß√µes.\n‚Ä¢ p90 = usu√°rios mais lentos.\n‚Ä¢ p99 = casos extremos.')">
              <span class="tooltiptext">O que √© isso?</span>
            </a>
          </div>
        </div>

        <div class="grafico">
          <div id="graficoPercentil" class="chart-container" data-chart="percentil"></div>
        </div>
      </div>

    </div>

  </div>

  <footer>
    <div class="dashButtons" id="footerButonsUnico">
      <a href="./home.html"><img style="border-radius:0" src="../../Images/home.svg"></a>
      <a href="./Gustavo.html"><img src="../../Images/Colaboradores/Colaborador2.svg"></a>
      <a href="./Pedro.html"><img src="../../Images/Colaboradores/Colaborador5.svg"></a>
    </div>
    <p>Developed by Pedro Claudino Barbosa</p>
  </footer>

</body>

</html>

<script src="../../js/sidebar.js"></script>
<script src="../../js/popups.js"></script>
<script src="../../js/verificacaoPermissoes.js"></script>

<!-- APEXCHARTS -->
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

<!-- ======================================================= -->
<!--              POPUP DE EXPLICA√á√ÉO (OFICIAL)             -->
<!-- ======================================================= -->
<script>
  server_nome.innerHTML= `${sessionStorage.servidorNome}`;
  server_localizacao.innerHTML= `${sessionStorage.servidorLocalizacao}`;

  function pop_up_info(texto) {
    const f = texto.replace(/\n/g, "<br>");

    document.getElementById("popup_screen").innerHTML = `
        <div class="popup_container">
            <div class="popup">
                <h1 style="margin-bottom: 10px;">Informa√ß√µes</h1>

                <div class="subtitulo_popup" style="text-align:center; margin-bottom:10px; font-weight:bold;">
                    ${f.split("<br>")[0]}
                </div>

                <div class="inputs" style="text-align:justify; line-height:22px; padding:40px;">
                    <div>${f.substring(f.indexOf("<br>") + 4)}</div>
                </div>

                <div class="btns_popup">
                    <button onclick="fechar_popup()">Fechar</button>
                </div>
            </div>
        </div>`;
  }
</script>

<!-- ======================================================= -->
<!--                 EXPANDIR / FECHAR GR√ÅFICO              -->
<!-- ======================================================= -->
<script>
  function fecharPopupGrafico() {
    const overlay = document.getElementById("grafico_overlay");
    overlay.style.display = "none";
    overlay.innerHTML = "";
  }

  document.getElementById("grafico_overlay").addEventListener("click", function (e) {
    if (e.target.id === "grafico_overlay") fecharPopupGrafico();
  });

  let chartConfigs = {};
  let charts = {
    cacheMiss: null,
    cacheHit: null,
    req: null,
    percentil: null
  };

  function expandirGrafico(element) {
    const boxOriginal = element.closest(".box_grafico");
    const overlay = document.getElementById("grafico_overlay");

    overlay.innerHTML = "";
    overlay.style.display = "flex";

    const clone = boxOriginal.cloneNode(true);
    clone.classList.add("popup_mode");

    const btnFechar = document.createElement("div");
    btnFechar.classList.add("btn_fechar_popup_grafico");
    btnFechar.innerHTML = "&times;";
    btnFechar.onclick = fecharPopupGrafico;
    clone.prepend(btnFechar);

    overlay.appendChild(clone);

    const chartDivOriginal = boxOriginal.querySelector(".grafico .chart-container");
    const chartKey = chartDivOriginal.dataset.chart;   // cacheMiss, cacheHit, req, percentil
    const chartIdOriginal = chartDivOriginal.id;

    const graficoClone = clone.querySelector(".grafico");
    graficoClone.innerHTML = `<div id="${chartIdOriginal}_popup"></div>`;

    const baseOptions = chartConfigs[chartKey];
    if (!baseOptions) return;

    const popupOptions = JSON.parse(JSON.stringify(baseOptions));

// üî• REAPLICA FORMATTERS QUE O JSON REMOVE
if (popupOptions.yaxis && popupOptions.yaxis.labels) {
  popupOptions.yaxis.labels.formatter = function (val) {
    if (popupOptions.series && popupOptions.series[0].name.includes('%')) {
      return val.toFixed(0) + "%";
    }
    if (popupOptions.series && popupOptions.series[0].name.includes('ms')) {
      return val.toFixed(0) + " ms";
    }
    return val.toFixed(0);
  };
}

if (popupOptions.tooltip) {
  popupOptions.tooltip.y = {
    formatter: function (val) {
      if (popupOptions.series && popupOptions.series[0].name.includes('%')) {
        return val.toFixed(2) + "%";
      }
      if (popupOptions.series && popupOptions.series[0].name.includes('ms')) {
        return val.toFixed(2) + " ms";
      }
      return val.toFixed(2);
    }
  };
}

// üî• FOR√áAR FORMATTER DO EIXO Y NO POPUP (sem bug de decimais)
if (popupOptions.yaxis) {

  // Se for m√∫ltiplos eixos
  if (Array.isArray(popupOptions.yaxis)) {
    popupOptions.yaxis = popupOptions.yaxis.map(axis => ({
      ...axis,
      labels: {
        formatter: function (val) {
          if (axis.title && axis.title.text?.toLowerCase().includes("ms")) {
            return val.toFixed(0) + " ms";
          }
          if (axis.title && axis.title.text?.toLowerCase().includes("%")) {
            return val.toFixed(0) + "%";
          }
          return val.toFixed(0);
        }
      }
    }));
  }

  // Y √∫nico
  else {
    popupOptions.yaxis.labels = {
      formatter: function (val) {
        const seriesName = popupOptions.series?.[0]?.name?.toLowerCase() || "";

        if (seriesName.includes("%")) return val.toFixed(0) + "%";
        if (seriesName.includes("ms")) return val.toFixed(0) + " ms";

        return val.toFixed(0);
      }
    };
  }

}


    popupOptions.chart = popupOptions.chart || {};

    popupOptions.chart.height = 600;   // aumenta a altura real
    popupOptions.chart.width = 1000; // for√ßa largura total no popup
    popupOptions.chart.toolbar = popupOptions.chart.toolbar || {};
    popupOptions.chart.toolbar.offsetY = 0;


    const popupChart = new ApexCharts(
      document.querySelector(`#${chartIdOriginal}_popup`),
      popupOptions
    );
    popupChart.render();
  }
</script>
<!-- ======================================================= -->
<!--              L√ìGICA PRINCIPAL / APEXCHARTS             -->
<!-- ======================================================= -->
<script>
  let dataCSV = [];
  let DATA_SELECIONADA = null;

  // ===============================
  //    SELE√á√ÉO DE DATA
  // ===============================
  function selecionarData() {
    const data = document.getElementById("dataFiltro").value;
    if (!data) return;
    DATA_SELECIONADA = data;
    buscarCSVsPorData(data);
  }

  // ===============================
  //    BUSCAR CSVs DO DIA
  // ===============================
  async function buscarCSVsPorData(dataCompleta) {
    const [ano, mes, dia] = dataCompleta.split("-");

    let empresaId = sessionStorage.empresaId;
    const categoria = "eficiencia_entrega";
    let servidorId = sessionStorage.servidorUuid;

    const prefixo = `${empresaId}/${categoria}/${servidorId}/${ano}/${mes}/${dia}/`;
    const pURL = encodeURIComponent(prefixo);

    let linhas = [];

    for (let i = 0; i < 500; i++) {
      const url = `/bucket/read/${pURL}/${i}`;
      try {
        const resp = await fetch(url);
        if (!resp.ok) break;
        const json = await resp.json();
        linhas = linhas.concat(json.rows);
      } catch {
        break;
      }
    }

    if (!linhas.length) {
      console.warn("Nenhum CSV encontrado para:", dataCompleta);
      dataCSV = [];
      destruirGraficos();
      return;
    }

    dataCSV = linhas;
    atualizarKPIs();
    atualizarGraficos();
  }

  // ===============================
  //    DESTRUIR GR√ÅFICOS APEX
  // ===============================
  function destruirGraficos() {
    if (charts.cacheMiss) { charts.cacheMiss.destroy(); charts.cacheMiss = null; }
    if (charts.cacheHit) { charts.cacheHit.destroy(); charts.cacheHit = null; }
    if (charts.req) { charts.req.destroy(); charts.req = null; }
    if (charts.percentil) { charts.percentil.destroy(); charts.percentil = null; }
  }

  // ===============================
  //           KPIs
  // ===============================
  function atualizarKPIs() {
    if (!dataCSV.length) return;

    const u = dataCSV[dataCSV.length - 1];

    const cards = document.querySelectorAll(".card_kpi");

    const txtSaude = document.getElementById("metrica_saude");
    const txtDisp = document.getElementById("metrica_disponibilidade");
    const txtLat = document.getElementById("metrica_latencia");
    const txtEfic = document.getElementById("metrica_entrega");

    const cardSaude = cards[0];
    const cardDisp = cards[1];
    const cardLat = cards[2];
    const cardEfic = cards[3];

    const iconSaude = cardSaude.querySelector(".card_kpi_status img");
    const iconDisp = cardDisp.querySelector(".card_kpi_status img");
    const iconLat = cardLat.querySelector(".card_kpi_status img");
    const iconEfic = cardEfic.querySelector(".card_kpi_status img");

    const valSaude = Number(u.saude || 0);
    const valDisp = Number(u.disponibilidade || 0);
    const valLat = Number(u.latencia_media || 0);
    const valEfic = Number(u.eficiencia || 0);

    txtSaude.textContent = `${valSaude.toFixed(2)}%`;
    txtDisp.textContent = `${valDisp.toFixed(2)}%`;
    txtLat.textContent = `${valLat.toFixed(2)} ms`;
    txtEfic.textContent = `${valEfic.toFixed(2)}%`;

    aplicarEstadoKPI(valSaude, "saude", cardSaude, txtSaude, iconSaude);
    aplicarEstadoKPI(valDisp, "disponibilidade", cardDisp, txtDisp, iconDisp);
    aplicarEstadoKPI(valLat, "latencia", cardLat, txtLat, iconLat);
    aplicarEstadoKPI(valEfic, "eficiencia", cardEfic, txtEfic, iconEfic);
  }

  // ===============================
  //       APLICAR ESTADOS KPI
  // ===============================
  function aplicarEstadoKPI(valor, tipo, cardElemento, textoElemento, iconElemento) {
    const statusElemento = cardElemento.querySelector(".card_kpi_status");

    statusElemento.classList.remove("estavel", "atencao", "critico");
    textoElemento.classList.remove("estavel_texto", "atencao_texto", "critico_texto");

    let estado = "";
    let icone = "";

    if (tipo === "saude") {
      if (valor >= 80) { estado = "estavel"; icone = "icone_positivo.svg"; }
      else if (valor >= 50) { estado = "atencao"; icone = "icone_atencao.svg"; }
      else { estado = "critico"; icone = "icone_negativo.svg"; }
    }

    if (tipo === "disponibilidade") {
      if (valor >= 99) { estado = "estavel"; icone = "icone_positivo.svg"; }
      else if (valor >= 97) { estado = "atencao"; icone = "icone_atencao.svg"; }
      else { estado = "critico"; icone = "icone_negativo.svg"; }
    }

    if (tipo === "eficiencia") {
      if (valor >= 90) { estado = "estavel"; icone = "icone_positivo.svg"; }
      else if (valor >= 70) { estado = "atencao"; icone = "icone_atencao.svg"; }
      else { estado = "critico"; icone = "icone_negativo.svg"; }
    }

    if (tipo === "latencia") {
      if (valor <= 50) { estado = "estavel"; icone = "icone_positivo.svg"; }
      else if (valor <= 150) { estado = "atencao"; icone = "icone_atencao.svg"; }
      else { estado = "critico"; icone = "icone_negativo.svg"; }
    }

    statusElemento.classList.add(estado);
    textoElemento.classList.add(estado + "_texto");
    iconElemento.src = `../../assets/icons/${icone}`;
  }

  // ===============================
  //        ATUALIZAR GR√ÅFICOS
  // ===============================
  function atualizarGraficos() {
    destruirGraficos();
    if (!dataCSV.length) return;

    // Ordenar cronologicamente
    dataCSV.sort(
      (a, b) => new Date(a.data.replace(" ", "T")) - new Date(b.data.replace(" ", "T"))
    );

    const xValues = dataCSV.map(d => {
      return new Date(d.data.replace(" ", "T")).getTime();
    });

    // ================================
    // üî• DEFINIR ZOOM INICIAL NOS √öLTIMOS 5 PONTOS
    // ================================
    let zoomInicio = null;
    let zoomFim = null;

    if (xValues.length > 5) {
      zoomInicio = xValues[xValues.length - 5];
      zoomFim = xValues[xValues.length - 1];
    } else if (xValues.length > 1) {
      zoomInicio = xValues[0];
      zoomFim = xValues[xValues.length - 1];
    }

    const missPercent = dataCSV.map(d => {
      const miss = Number(d.cache_miss_total || 0);
      const req = Number(d.total_requisicoes || 1);
      return (miss / req) * 100;
    });

    const hitPercent = dataCSV.map(d => {
      const hit = Number(d.cache_hit_total || 0);
      const req = Number(d.total_requisicoes || 1);
      return (hit / req) * 100;
    });

    const reqValues = dataCSV.map(d => Number(d.total_requisicoes || 0));

    const p50 = dataCSV.map(d => Number(d.p50 || 0));
    const p90 = dataCSV.map(d => Number(d.p90 || 0));
    const p99 = dataCSV.map(d => Number(d.p99 || 0));

    const limitesMiss = { alert: 70, critical: 75 };
    const limitesHit = { alert: 30, critical: 25 };

    const baseChart = {
      animations: {
        enabled: true,
        easing: 'easeinout',
        speed: 600
      },
      zoom: {
        enabled: true,
        type: 'x',
        autoScaleYaxis: true
      },
      toolbar: {
        show: true,
        tools: {
          selection: true,
          zoom: true,
          zoomin: true,
          zoomout: true,
          pan: true,
          reset: true
        },
        autoSelected: 'zoom'
      }
    };

    const baseXAxis = {
      type: 'datetime',
      labels: { datetimeUTC: false }
    };

    // ====================================
    // CACHE MISS
    // ====================================
    chartConfigs.cacheMiss = {
      chart: Object.assign({ type: 'line', height: "100%", width: "100%" }, baseChart),
      series: [{
        name: 'Cache Miss (%)',
        data: xValues.map((x, i) => [x, missPercent[i]])
      }],
      stroke: { curve: 'smooth', width: 3 },
      dataLabels: { enabled: false },
      xaxis: {
        ...baseXAxis,
        min: zoomInicio,
        max: zoomFim
      },
      yaxis: {
        max: 100,
        min: 0,
        labels: { formatter: val => `${val.toFixed(0)}%` }
      },
      tooltip: {
        x: { format: 'dd/MM HH:mm' },
        y: { formatter: val => `${val.toFixed(2)}%` }
      },
      annotations: {
        yaxis: [
          { y: limitesMiss.alert, borderColor: "#ffc917", label: { text: "Aten√ß√£o", style: { background: "#ffc917", color: "#000" } } },
          { y: limitesMiss.critical, borderColor: "#ff3b3b", label: { text: "Cr√≠tico", style: { background: "#ff3b3b", color: "#fff" } } }
        ]
      },
      colors: ['#FF0267']
    };

    charts.cacheMiss = new ApexCharts(
      document.querySelector("#graficoCacheMiss"),
      chartConfigs.cacheMiss
    );

    charts.cacheMiss.render().then(() => {
      // üî• APLICA O ZOOM AP√ìS O RENDER ‚Äî solu√ß√£o do bug
      charts.cacheMiss.updateOptions({
        xaxis: {
          min: zoomInicio,
          max: zoomFim
        }
      }, false, false);
    });

    // ================== CACHE HIT ==================
    chartConfigs.cacheHit = {
      chart: Object.assign({ type: 'line', height: "100%", width: "100%" }, baseChart),
      series: [{
        name: 'Cache Hit (%)',
        data: xValues.map((x, i) => [x, hitPercent[i]])
      }],
      stroke: { curve: 'smooth', width: 3 },
      dataLabels: { enabled: false },
      xaxis: {
        ...baseXAxis,
        min: zoomInicio,
        max: zoomFim
      },
      yaxis: {
        max: 100,
        min: 0,
        labels: { formatter: val => `${val.toFixed(0)}%` }
      },
      tooltip: {
        x: { format: 'dd/MM HH:mm' },
        y: { formatter: val => `${val.toFixed(2)}%` }
      },
      annotations: {
        yaxis: [
          { y: limitesHit.alert, borderColor: "#ffc917", label: { text: "Aten√ß√£o", style: { background: "#ffc917", color: "#000" } } },
          { y: limitesHit.critical, borderColor: "#ff3b3b", label: { text: "Cr√≠tico", style: { background: "#ff3b3b", color: "#fff" } } }
        ]
      },
      colors: ['#6DF8A4']
    };

    charts.cacheHit = new ApexCharts(
      document.querySelector("#graficoCacheHit"),
      chartConfigs.cacheHit
    );

    charts.cacheHit.render().then(() => {
      charts.cacheHit.updateOptions({
        xaxis: {
          min: zoomInicio,
          max: zoomFim
        }
      }, false, false);
    });


    // ================== REQUISI√á√ïES ==================
    chartConfigs.req = {
      chart: Object.assign({ type: 'bar', height: "100%", width: "100%" }, baseChart),
      series: [{
        name: 'Requisi√ß√µes',
        data: xValues.map((x, i) => ({ x, y: reqValues[i] }))
      }],
      plotOptions: { bar: { borderRadius: 6, columnWidth: '60%' } },
      dataLabels: { enabled: false },
      xaxis: {
        ...baseXAxis,
        min: zoomInicio,
        max: zoomFim
      },
      tooltip: {
        x: { format: 'dd/MM HH:mm' },
        y: { formatter: val => `${val.toFixed(0)} req` }
      },
      colors: ['#8979FF']
    };

    charts.req = new ApexCharts(
      document.querySelector("#graficoRequisicoes"),
      chartConfigs.req
    );
    charts.req.render();

    // ================== PERCENTIL ==================
    chartConfigs.percentil = {
      chart: Object.assign({ type: 'line', height: "100%", width: "100%" }, baseChart),
      series: [
        { name: 'p50', data: xValues.map((x, i) => [x, p50[i]]) },
        { name: 'p90', data: xValues.map((x, i) => [x, p90[i]]) },
        { name: 'p99', data: xValues.map((x, i) => [x, p99[i]]) }
      ],
      stroke: { curve: 'smooth', width: 3 },
      dataLabels: { enabled: false },
      xaxis: {
        ...baseXAxis,
        min: zoomInicio,
        max: zoomFim
      },
      yaxis: {
        labels: { formatter: val => `${val.toFixed(0)} ms` }
      },
      tooltip: {
        x: { format: 'dd/MM HH:mm' },
        y: { formatter: val => `${val.toFixed(2)} ms` }
      },
      colors: ['#5A6CF3', '#54D5E4', '#FF7AD9']
    };

    charts.percentil = new ApexCharts(
      document.querySelector("#graficoPercentil"),
      chartConfigs.percentil
    );
    charts.percentil.render();
  }


  // ===============================
  //   SETAR DATA AO CARREGAR
  // ===============================
  window.addEventListener("load", () => {
    // j√° chama listarPermissoesReload pelo onload do body
    const hoje = new Date().toISOString().split("T")[0];
    const inputData = document.getElementById("dataFiltro");
    if (inputData) {
      inputData.value = hoje;
      selecionarData();
    }
  });
</script>